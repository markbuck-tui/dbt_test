{"results": [{"node": {"name": "v_booking_fact_uk", "root_path": "C:\\Users\\EXTMB2\\github\\dbt_test", "resource_type": "model", "path": "v_booking_fact_uk.sql", "original_file_path": "models\\v_booking_fact_uk.sql", "package_name": "dbt_test", "raw_sql": "{{\r\n  config(materialized='view')\r\n}}\r\n\r\nWITH fl_acr_booking AS (\r\n\tSELECT\r\n\t\tbk_1.sk_booking_id\r\n\t\t,bk_1.booking_version\r\n\t\t,bk_1.atcom_res_id\r\n\t\t,bk_1.atcom_res_version\r\n    ,bk_1.atcom_market_id -- CG ADDED in V1.06 for new Source Market Derivation\r\n\t\t,bk_1.number_of_adults\r\n\t\t,bk_1.number_of_children\r\n\t\t,bk_1.number_of_infants\r\n\t\t,bk_1.number_of_passengers\r\n\t\t,bk_1.sk_season_id\r\n\t\t,bk_1.booking_status\r\n\t\t,bk_1.atcom_agent_id\r\n\t\t,bk_1.atcom_sell_currency_id\r\n\t\t,bk_1.season_date\r\n\t\t,bk_1.confirmed_on\r\n\t\t,bk_1.cancelled_on\r\n\t\t,bk_1.source_created_on\r\n\t\t,bk_1.modified_on\r\n\t\t,bk_1.dwh_created_on\r\n\t\t,bk_1.dwh_modified_on\r\n\r\n\tFROM opa_stg_uk.fl_acr_booking bk_1\r\n\tWHERE bk_1.file_dt = (SELECT MAX(bk_2.file_dt) FROM opa_stg_uk.fl_acr_booking bk_2 WHERE bk_1.sk_booking_id = bk_2.sk_booking_id AND bk_1.booking_version = bk_2.booking_version)\r\n\tAND bk_1.booking_version = (SELECT MAX(bk_3.booking_version) FROM opa_stg_uk.fl_acr_booking bk_3 WHERE bk_1.sk_booking_id = bk_3.sk_booking_id)\r\n\tAND (bk_1.sk_season_id > 201701 OR bk_1.sk_booking_id IS NULL)\r\n\r\n\t-- To be removed when running against all bookings\r\n\tAND bk_1.sk_booking_id IN ('380402','975528','10016009','10063844','15994298','22568921','25059884','27813713','28536240','30846203','33404409','20348866','31280892','35353771')\r\n)\r\n,ar_sellstatic AS (\r\n\tSELECT\r\n\t\tsls_1.sell_stc_id\r\n\t\t,sls_1.stc_stk_id\r\n\tFROM opa_stg_uk.ar_sellstatic sls_1\r\n\tWHERE sls_1.file_dt = (SELECT MAX(sls_2.file_dt) FROM opa_stg_uk.ar_sellstatic sls_2 WHERE sls_1.sell_stc_id = sls_2.sell_stc_id)\r\n)\r\n,ar_staticstock AS (\r\n\tSELECT\r\n\t\tss.stc_stk_id\r\n\t\t,ss.cd\r\n\tFROM opa_stg_uk.ar_staticstock ss\r\n\tWHERE ss.file_dt = (SELECT MAX(ss_2.file_dt) FROM opa_stg_uk.ar_staticstock ss_2 WHERE ss.stc_stk_id = ss_2.stc_stk_id)\r\n)\r\n,ar_staticroom AS (\r\n  SELECT\r\n\tsr.stc_rm_id\r\n\t,sr.stc_stk_id\r\n\t,sr.rm_id\r\n  FROM opa_stg_uk.ar_staticroom sr\r\n  WHERE sr.file_dt = (SELECT MAX(sr_2.file_dt) FROM opa_stg_uk.ar_staticroom sr_2 WHERE sr.stc_rm_id = sr_2.stc_rm_id)\r\n)\r\n,ar_sellunit AS (\r\n\tSELECT\r\n\t\tsu.sell_unit_id\r\n\t\t,su.rm_id\r\n\t\t,su.bb_cd_id\r\n\tFROM opa_stg_uk.ar_sellunit su\r\n\tWHERE su.file_dt = (SELECT MAX(su_2.file_dt) FROM opa_stg_uk.ar_sellunit su_2 WHERE su.sell_unit_id = su_2.sell_unit_id)\r\n)\r\n,ar_usercodes AS (\r\n\tSELECT DISTINCT\r\n\t\tuc_1.user_cd_id\r\n\t\t,uc_1.cd\r\n\t\t,uc_1.name\r\n\tFROM opa_stg_uk.ar_usercodes uc_1\r\n\tWHERE uc_1.file_dt = (SELECT MAX(uc_2.file_dt) FROM opa_stg_uk.ar_usercodes uc_2 WHERE uc_1.user_cd_id = uc_2.user_cd_id)\r\n)\r\n,fl_acr_booking_service AS (\r\n\tSELECT\r\n\t\tbk_ser_1.sk_booking_service_id\r\n\t\t,bk_ser_1.sk_booking_id\r\n\t\t,bk_ser_1.sk_service_id\r\n\t\t,bk_ser_1.service_version\r\n\t\t,bk_ser_1.booking_version\r\n\tFROM opa_stg_uk.fl_acr_booking_service bk_ser_1\r\n\tWHERE bk_ser_1.file_dt = (SELECT MAX(bk_ser_2.file_dt) FROM opa_stg_uk.fl_acr_booking_service bk_ser_2 WHERE bk_ser_1.sk_booking_service_id = bk_ser_2.sk_booking_service_id)\r\n\tAND bk_ser_1.booking_version = (SELECT MAX(bk_ser_3.booking_version) FROM opa_stg_uk.fl_acr_booking_service bk_ser_3 WHERE bk_ser_1.sk_booking_id = bk_ser_3.sk_booking_id)\r\n\tAND bk_ser_1.service_version = (SELECT MAX(bk_ser_4.service_version) FROM opa_stg_uk.fl_acr_booking_service bk_ser_4 WHERE bk_ser_1.sk_service_id = bk_ser_4.sk_service_id)\r\n\r\n\t-- To be removed when running against all bookings\r\n\tAND bk_ser_1.sk_booking_id IN ('380402','975528','10016009','10063844','15994298','22568921','25059884','27813713','28536240','30846203','33404409','20348866','31280892','35353771')\r\n)\r\n,fl_acr_service AS (\r\n\tSELECT\r\n\t\tser_1.sk_service_id\r\n\t\t,ser_1.atcom_ser_id\r\n\t\t,ser_1.atcom_dep_point_id\r\n\t\t,ser_1.service_version\r\n\t\t,ser_1.service_status\r\n\t\t,ser_1.direction\r\n\t\t,ser_1.sell_type\r\n\t\t,ser_1.service_type\r\n\t\t,ser_1.flight_type_code\r\n\t\t,ser_1.service_start_date1\r\n\t\t,ser_1.service_end_date1\r\n\t\t,ser_1.departure_flight_number\r\n\t\t,ser_1.atcom_arr_point_id\r\n\t\t,ser_1.source_stock_type_code\r\n\tFROM opa_stg_uk.fl_acr_service ser_1\r\n\tWHERE ser_1.file_dt = (SELECT MAX(ser_2.file_dt) FROM opa_stg_uk.fl_acr_service ser_2 WHERE ser_1.sk_service_id = ser_2.sk_service_id AND ser_1.service_version = ser_2.service_version)\r\n)\r\n,fl_acr_service_element AS (\r\n\tSELECT\r\n\t\tser_e_1.sk_service_id\r\n\t\t,ser_e_1.service_version\r\n\t\t,ser_e_1.atcom_sub_ser_id\r\n\tFROM opa_stg_uk.fl_acr_service_element ser_e_1\r\n\tWHERE ser_e_1.file_dt = (SELECT MAX(ser_e_2.file_dt) FROM opa_stg_uk.fl_acr_service_element ser_e_2 WHERE ser_e_1.sk_service_element_id = ser_e_2.sk_service_element_id)\r\n)\r\n,ar_transroute AS (\r\n\tSELECT\r\n\t\ttr.trans_route_id\r\n\t\t,tr.route_cd\r\n\tFROM opa_stg_uk.ar_transroute tr\r\n\tWHERE tr.file_dt = (SELECT MAX(tr_2.file_dt) FROM opa_stg_uk.ar_transroute tr_2 WHERE tr.trans_route_id = tr_2.trans_route_id)\r\n)\r\n,ar_transinvroute AS (\r\n\tSELECT\r\n\t\ttir.trans_inv_route_id\r\n\t\t,tir.trans_route_id\r\n\tFROM opa_stg_uk.ar_transinvroute tir\r\n\tWHERE tir.file_dt = (SELECT MAX(tir_2.file_dt) FROM opa_stg_uk.ar_transinvroute tir_2 WHERE tir.trans_inv_route_id = tir_2.trans_inv_route_id)\r\n)\r\n,ar_transinvroutesector AS (\r\n\tSELECT\r\n\t\ttirs.trans_inv_route_id\r\n\t\t,tirs.trans_inv_sec_id\r\n\t\t,tirs.trans_inv_route_sec_id\r\n\tFROM opa_stg_uk.ar_transinvroutesector tirs\r\n\tWHERE tirs.file_dt = (SELECT MAX(tirs_2.file_dt) FROM opa_stg_uk.ar_transinvroutesector tirs_2 WHERE tirs.trans_inv_route_sec_id = tirs_2.trans_inv_route_sec_id)\r\n),\r\nar_transinvsector AS (\r\n\tSELECT\r\n\t\ttis.trans_inv_sec_id\r\n\t\t,tis.dep_dt_tm\r\n\tFROM opa_stg_uk.ar_transinvsector tis\r\n\tWHERE tis.file_dt = (SELECT MAX(tis_2.file_dt) FROM opa_stg_uk.ar_transinvsector tis_2 WHERE tis.trans_inv_sec_id = tis_2.trans_inv_sec_id)\r\n)\r\n,ar_point AS (\r\n\tSELECT\r\n\t\tp.pt_id\r\n\t\t,p.pt_cd\r\n\tFROM opa_stg_uk.ar_point p\r\n\tWHERE p.file_dt = (SELECT MAX(p_2.file_dt) FROM opa_stg_uk.ar_point p_2 WHERE p.pt_id = p_2.pt_id)\r\n)\r\n,dates AS (\r\n\tSELECT\r\n\t\tdd.bk_date\r\n\t\t,dd.group_season_code\r\n\tFROM opa_stg_all.date_dim dd\r\n)\r\n,booking_service AS (\r\n\tSELECT\r\n\t\tbk_ser.sk_booking_id\r\n\t\t,bk_ser.booking_version\r\n\t\t,bk_ser.sk_service_id\r\n\t\t,bk_ser.service_version\r\n\t\t,bk_ser.sk_booking_service_id\r\n\t\t,ser.service_type\r\n\t\t,ser.source_stock_type_code\r\n\t\t,ser.sell_type\r\n\t\t,ser.service_status\r\n\t\t,ser.flight_type_code\r\n\t\t,ser.service_start_date1\r\n\t\t,ser.service_end_date1\r\n\t\t,tis.dep_dt_tm\r\n\t\t,ser.departure_flight_number\r\n\t\t,ser.direction\r\n\t\t,tr.route_cd\r\n\t\t,dpt.pt_cd\r\n\t\t,CASE WHEN\r\n\t\t\t-- All flight cancelled\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t=\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tTHEN\r\n\t\t\tCASE WHEN\r\n\t\t\t\tser.service_start_date1 =\r\n\t\t\t\t\tMIN(CASE WHEN\r\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\r\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\r\n\t\t\t\t\t\tTHEN ser.service_start_date1\r\n\t\t\t\t\t\tELSE NULL\r\n\t\t\t\t\t\tEND\r\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\tTHEN apt.pt_cd\r\n\t\t\t\tELSE NULL\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tCASE WHEN\r\n\t\t\t\tser.service_start_date1 =\r\n\t\t\t\t\tMIN(CASE WHEN\r\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\r\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\r\n\t\t\t\t\t\tTHEN ser.service_start_date1\r\n\t\t\t\t\t\tELSE NULL\r\n\t\t\t\t\t\tEND\r\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\tAND ser.service_status = 'CON'\r\n\t\t\t\tTHEN apt.pt_cd\r\n\t\t\t\tELSE NULL\r\n\t\t\tEND\r\n\t\tEND AS min_flight_gateway\r\n\r\n\t\t,CASE WHEN\r\n\t\t\t-- All flight cancelled\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t=\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tTHEN\r\n\t\t\tCASE WHEN\r\n\t\t\t\tser.service_start_date1 =\r\n\t\t\t\t\tMIN(CASE WHEN\r\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\r\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\r\n\t\t\t\t\t\tTHEN ser.service_start_date1\r\n\t\t\t\t\t\tELSE NULL\r\n\t\t\t\t\t\tEND\r\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\tTHEN\r\n\t\t\t\t\tCASE WHEN tr.route_cd IS NULL\r\n\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\tser.departure_flight_number|| '|' || dpt.pt_cd || '|' || apt.pt_cd|| '|' || CAST(SUBSTR(ser.service_start_date1,1,4)||SUBSTR(ser.service_start_date1,6,2)||SUBSTR(ser.service_start_date1,9,2) AS VARCHAR)\r\n\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\ttr.route_cd || '|' || SUBSTRING(tis.dep_dt_tm, 1, 4) || SUBSTRING(tis.dep_dt_tm, 6, 2) || SUBSTRING(tis.dep_dt_tm, 9, 2)\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tELSE NULL\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tCASE WHEN\r\n\t\t\t\tser.service_start_date1 =\r\n\t\t\t\t\tMIN(CASE WHEN\r\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\r\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\r\n\t\t\t\t\t\tTHEN ser.service_start_date1\r\n\t\t\t\t\t\tELSE NULL\r\n\t\t\t\t\t\tEND\r\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t\tAND ser.service_status = 'CON'\r\n\t\t\t\tTHEN\r\n\t\t\t\t\tCASE WHEN tr.route_cd IS NULL\r\n\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\tser.departure_flight_number|| '|' || dpt.pt_cd || '|' || apt.pt_cd|| '|' || CAST(SUBSTR(ser.service_start_date1,1,4)||SUBSTR(ser.service_start_date1,6,2)||SUBSTR(ser.service_start_date1,9,2) AS VARCHAR)\r\n\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\ttr.route_cd || '|' || SUBSTRING(tis.dep_dt_tm, 1, 4) || SUBSTRING(tis.dep_dt_tm, 6, 2) || SUBSTRING(tis.dep_dt_tm, 9, 2)\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tELSE NULL\r\n\t\t\tEND\r\n\t\tEND\tAS min_flight_id\r\n\r\n\t\t,CASE WHEN\r\n\t\t\t-- All flight cancelled\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t=\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tTHEN\r\n\t\t\tCASE WHEN\r\n\t\t\t\tser.service_start_date1 =\r\n\t\t\t\t\tMAX(CASE WHEN\r\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\r\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\r\n\t\t\t\t\t\tTHEN ser.service_start_date1\r\n\t\t\t\t\t\tELSE NULL\r\n\t\t\t\t\t\tEND\r\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\tTHEN\r\n\t\t\t\t\tCASE WHEN tr.route_cd IS NULL\r\n\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\tser.departure_flight_number|| '|' || dpt.pt_cd || '|' || apt.pt_cd|| '|' || CAST(SUBSTR(ser.service_start_date1,1,4)||SUBSTR(ser.service_start_date1,6,2)||SUBSTR(ser.service_start_date1,9,2) AS VARCHAR)\r\n\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\ttr.route_cd || '|' || SUBSTRING(tis.dep_dt_tm, 1, 4) || SUBSTRING(tis.dep_dt_tm, 6, 2) || SUBSTRING(tis.dep_dt_tm, 9, 2)\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tELSE NULL\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tCASE WHEN\r\n\t\t\t\tser.service_start_date1 =\r\n\t\t\t\t\tMAX(CASE WHEN\r\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\r\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\r\n\t\t\t\t\t\tTHEN ser.service_start_date1\r\n\t\t\t\t\t\tELSE NULL\r\n\t\t\t\t\t\tEND\r\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t\tAND ser.service_status = 'CON'\r\n\t\t\t\tTHEN\r\n\t\t\t\t\tCASE WHEN tr.route_cd IS NULL\r\n\t\t\t\t\t\tTHEN\r\n\t\t\t\t\t\t\tser.departure_flight_number|| '|' || dpt.pt_cd || '|' || apt.pt_cd|| '|' || CAST(SUBSTR(ser.service_start_date1,1,4)||SUBSTR(ser.service_start_date1,6,2)||SUBSTR(ser.service_start_date1,9,2) AS VARCHAR)\r\n\t\t\t\t\t\tELSE\r\n\t\t\t\t\t\t\ttr.route_cd || '|' || SUBSTRING(tis.dep_dt_tm, 1, 4) || SUBSTRING(tis.dep_dt_tm, 6, 2) || SUBSTRING(tis.dep_dt_tm, 9, 2)\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tELSE NULL\r\n\t\t\tEND\r\n\t\tEND AS max_flight_id\r\n\r\n\r\n\t\t-- MULTICENTRE\r\n\t\t,CASE WHEN\r\n\t\t\t-- All multicentre services cancelled\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t=\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tTHEN\r\n\t\t\tMIN(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM')\r\n\t\t\t\tTHEN ser.service_start_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tELSE\r\n\t\t\tMIN(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' AND ser.service_status = 'CON')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CON')\r\n\t\t\t\tTHEN ser.service_start_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tEND\tAS min_multi_center_date\r\n\r\n\t\t,CASE WHEN\r\n\t\t\t-- All multicentre services cancelled\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t=\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tTHEN\r\n\t\t\tMAX(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM')\r\n\t\t\t\tTHEN ser.service_end_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tELSE\r\n\t\t\tMAX(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' AND ser.service_status = 'CON')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CON')\r\n\t\t\t\tTHEN ser.service_end_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tEND AS max_multi_center_date\r\n\r\n\r\n\t\t-- ACCOM\r\n\t\t,CASE WHEN\r\n\t\t\t-- All accom services cancelled\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t=\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tTHEN\r\n\t\t\tMIN(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU'))\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM')\r\n\t\t\t\tTHEN ser.service_start_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tELSE\r\n\t\t\tMIN(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CON')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CON')\r\n\t\t\t\tTHEN ser.service_start_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tEND AS min_accom_date\r\n\t\t,CASE WHEN\r\n\t\t\t-- All accom services cancelled\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t=\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tTHEN\r\n\t\t\tMAX(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU'))\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM')\r\n\t\t\t\tTHEN ser.service_end_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tELSE\r\n\t\t\tMAX(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CON')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CON')\r\n\t\t\t\tTHEN ser.service_end_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tEND AS max_accom_date\r\n\r\n\r\n\t\t-- CRUISE\r\n\t\t,CASE WHEN\r\n\t\t\t-- All accom services cancelled\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t=\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tTHEN\r\n\t\t\tMIN(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'CRU')\r\n\t\t\t\tTHEN ser.service_start_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tELSE\r\n\t\t\tMIN(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CON')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' AND ser.service_status = 'CON')\r\n\t\t\t\tTHEN ser.service_start_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tEND AS min_cruise_date\r\n\t\t,CASE WHEN\r\n\t\t\t-- All accom services cancelled\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t=\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tTHEN\r\n\t\t\tMAX(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'CRU')\r\n\t\t\t\tTHEN ser.service_end_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tELSE\r\n\t\t\tMAX(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CON')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' AND ser.service_status = 'CON')\r\n\t\t\t\tTHEN ser.service_end_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tEND max_cruise_date\r\n\r\n\r\n\t\t-- FLIGHT\r\n\t\t,CASE WHEN\r\n\t\t\t-- All flight services cancelled\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t=\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tTHEN\r\n\t\t\tMIN(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\r\n\t\t\t\t--THEN tis.dep_dt_tm END)\r\n\t\t\t\tTHEN ser.service_start_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tELSE\r\n\t\t\tMIN(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\r\n\t\t\t\t--THEN tis.dep_dt_tm END)\r\n\t\t\t\tTHEN ser.service_start_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tEND AS min_flight_date\r\n\t\t,CASE WHEN\r\n\t\t\t-- All flight services cancelled\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t=\r\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tTHEN\r\n\t\t\tMAX(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\r\n\t\t\t\t--THEN tis.dep_dt_tm END)\r\n\t\t\t\tTHEN ser.service_start_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tELSE\r\n\t\t\tMAX(CASE WHEN\r\n\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\r\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\r\n\t\t\t\t--THEN tis.dep_dt_tm END)\r\n\t\t\t\tTHEN ser.service_start_date1 END)\r\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\tEND\tAS max_flight_date\r\n\r\n\t\t,sts.cd AS accom\r\n\t\t,su.bb_cd_id AS board_cd\r\n\t\t,uc_3.name AS board_name\r\n\t\t,str.stc_rm_id AS room\r\n\r\n\t\t-- Booking type derivation part 1\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- No outbound flight services on the booking are third party\r\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) = 0\r\n\t\tTHEN 0\r\n\t\tELSE\r\n\t\t\tCASE WHEN\r\n\t\t\t\t-- All outbound flight services are 3PF\r\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t=\r\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\r\n\t\t\tOR\r\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' AND ser.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) > 1\r\n\t\t\tTHEN 1\r\n\t\t\tELSE 0\r\n\t\t\tEND\r\n\t\tEND AS tpf_out_count\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- No outbound flight services on the booking are third party\r\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) = 0\r\n\t\tTHEN 0\r\n\t\tELSE\r\n\t\t\tCASE WHEN\r\n\t\t\t\t-- All outbound flight services are 3PF\r\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t=\r\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\r\n\t\t\tOR\r\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' AND ser.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) > 1\r\n\t\t\tTHEN 1\r\n\t\t\tELSE 0\r\n\t\t\tEND\r\n\t\tEND AS tpf_in_count\r\n\t\t,CASE WHEN\r\n\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\t-- No outbound flight services on the booking are third party\r\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) = 0\r\n\t\t\t\tTHEN 0\r\n\t\t\t\tELSE\r\n\t\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\t-- All outbound flight services are 3PF\r\n\t\t\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t\t\t=\r\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\r\n\t\t\t\t\tOR\r\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' AND ser.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) > 1\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tELSE 0\r\n\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\t\t+\r\n\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\t-- No outbound flight services on the booking are third party\r\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) = 0\r\n\t\t\t\tTHEN 0\r\n\t\t\t\tELSE\r\n\t\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\t-- All outbound flight services are 3PF\r\n\t\t\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t\t\t=\r\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\r\n\t\t\t\t\tOR\r\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' AND ser.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) > 1\r\n\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tELSE 0\r\n\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\t> 0\r\n\t\t\tTHEN 'Y'\r\n\t\t\tELSE 'N'\r\n\t\tEND AS tpf_indicator\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All accom cancelled\r\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\tTHEN CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') THEN 1 ELSE 0 END\r\n\t\t\tELSE CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CON' THEN 1 ELSE 0 END\r\n\t\tEND AS accom_count\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All cruise cancelled\r\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\tTHEN CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' THEN 1 ELSE 0 END\r\n\t\t\tELSE CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CON' THEN 1 ELSE 0 END\r\n\t\tEND AS cruise_count\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All flight out cancelled\r\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\tTHEN CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END\r\n\t\t\tELSE CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' AND ser.service_status = 'CON' THEN 1 ELSE 0 END\r\n\t\tEND AS flight_out_count\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All flight in cancelled\r\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\tTHEN CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END\r\n\t\t\tELSE CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' AND ser.service_status = 'CON' THEN 1 ELSE 0 END\r\n\t\tEND AS flight_ret_count\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All ahoc services cancelled\r\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'AHOC' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\tTHEN CASE WHEN ser.service_type = 'AHOC' THEN 1 ELSE 0 END\r\n\t\t\tELSE CASE WHEN ser.service_type = 'AHOC' AND ser.service_status = 'CON' THEN 1 ELSE 0 END\r\n\t\tEND AS thirdparty_count\r\n\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All flight out first date cancelled\r\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\tTHEN CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN ser.service_start_date1 ELSE NULL END\r\n\t\t\tELSE CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' AND ser.service_status = 'CON' THEN ser.service_start_date1 ELSE NULL END\r\n\t\tEND AS flight_out_first_date\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All flight in first date cancelled\r\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\r\n\t\t\tTHEN CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN ser.service_start_date1 ELSE NULL END\r\n\t\t\tELSE CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' AND ser.service_status = 'CON' THEN ser.service_start_date1 ELSE NULL END\r\n\t\tEND AS flight_ret_first_date\r\n\r\n\t-- Service and subservice\r\n\tFROM fl_acr_booking_service bk_ser\r\n\tLEFT OUTER JOIN fl_acr_service ser ON bk_ser.sk_service_id = ser.sk_service_id AND bk_ser.service_version = ser.service_version\r\n\tLEFT OUTER JOIN fl_acr_service_element ser_e ON ser.sk_service_id = ser_e.sk_service_id AND ser.service_version = ser_e.service_version\r\n\r\n\t-- Accom\r\n\tLEFT OUTER JOIN ar_sellstatic sls ON ser.atcom_ser_id = sls.sell_stc_id\r\n\tLEFT OUTER JOIN ar_staticstock sts ON sls.stc_stk_id = sts.stc_stk_id\r\n\r\n\t-- Room\r\n\tLEFT OUTER JOIN ar_sellunit su ON ser_e.atcom_sub_ser_id = su.sell_unit_id\r\n\tLEFT OUTER JOIN ar_staticroom str ON sts.stc_stk_id = str.stc_stk_id AND su.rm_id = str.rm_id\r\n\r\n\t-- Board\r\n\tLEFT OUTER JOIN ar_usercodes uc_3 ON su.bb_cd_id = uc_3.user_cd_id\r\n\r\n\t-- Flight\r\n\tLEFT OUTER JOIN ar_transinvroute tir ON ser.atcom_ser_id = tir.trans_inv_route_id\r\n\tLEFT OUTER JOIN ar_transroute tr ON tir.trans_route_id = tr.trans_route_id\r\n\tLEFT OUTER JOIN ar_transinvroutesector tirs ON tir.trans_inv_route_id = tirs.trans_inv_route_id\r\n      LEFT OUTER JOIN ar_transinvsector tis ON tirs.trans_inv_sec_id = tis.trans_inv_sec_id\r\n\tLEFT OUTER JOIN ar_point dpt ON ser.atcom_dep_point_id = dpt.pt_id\r\n\tLEFT OUTER JOIN ar_point apt ON ser.atcom_arr_point_id = apt.pt_id\r\n\r\n\tORDER BY\r\n\t\tbk_ser.sk_booking_id\r\n\t\t,bk_ser.booking_version\r\n\t\t,ser.source_stock_type_code\r\n\r\n)\r\n,ar_agent AS (\r\n\tSELECT DISTINCT\r\n\t\tag_1.agt_id\r\n\t\t,ag_1.def_mkt_id\r\n\t\t,ag_1.agt_tp_id\r\n\tFROM opa_stg_uk.ar_agent ag_1\r\n\tWHERE ag_1.file_dt = (SELECT MAX(ag_2.file_dt) FROM opa_stg_uk.ar_agent ag_2 WHERE ag_1.agt_id = ag_2.agt_id)\r\n)\r\n,ar_market AS (\r\n\tSELECT DISTINCT\r\n\t\tmk_1.mkt_id\r\n\t\t,mk_1.off_id\r\n\tFROM opa_stg_uk.ar_market mk_1\r\n\tWHERE mk_1.file_dt = (SELECT MAX(mk_2.file_dt) FROM opa_stg_uk.ar_market mk_2 WHERE mk_1.mkt_id = mk_2.mkt_id)\r\n)\r\n,ar_officename AS (\r\n\tSELECT DISTINCT\r\n\t\tofn_1.off_name_id\r\n\t\t,ofn_1.cd\r\n\t\t,ofn_1.name\r\n\t\t-- ,sm.source_market_code\r\n\tFROM opa_stg_uk.ar_officename ofn_1\r\n\t-- LEFT OUTER JOIN opa_stg_all.source_market sm ON 'UKATCOM|' || ofn_1.cd = bk_source_market\r\n\tWHERE ofn_1.file_dt = (SELECT MAX(ofn_2.file_dt) FROM opa_stg_uk.ar_officename ofn_2 WHERE ofn_1.off_name_id = ofn_2.off_name_id)\r\n)\r\n,ar_currency AS (\r\n\tSELECT DISTINCT\r\n\t\tcur_1.cur_id\r\n\t\t,cur_1.cd\r\n\t\t,cur_1.name\r\n\tFROM opa_stg_uk.ar_currency cur_1\r\n\tWHERE cur_1.file_dt = (SELECT MAX(cur_2.file_dt) FROM opa_stg_uk.ar_currency cur_2 WHERE cur_1.cur_id = cur_2.cur_id)\r\n)\r\n\t,booking_fact_margin AS (\r\n\tSELECT\r\n\t\tbff_1.bk_booking\r\n\t\t,bff_1.ffd_flag\r\n\t\t,bff_1.sm_currency\r\n\t\t,bff_1.sm_revenue\r\n\t\t,bff_1.sm_cnx_and_amend_revenue\r\n\t\t,bff_1.sm_accommodation_costs\r\n\t\t,bff_1.sm_early_booking_discounts\r\n\t\t,bff_1.sm_late_booking_discounts\r\n\t\t,bff_1.sm_flying_costs\r\n\t\t,bff_1.sm_other_costs\r\n\t\t,bff_1.sm_distribution_costs\r\n\t\t,bff_1.sm_non_margin_items\r\n\t\t,bff_1.sm_margin\r\n\t\t,bff_1.smg_currency\r\n\t\t,bff_1.smg_revenue\r\n\t\t,bff_1.smg_cnx_and_amend_revenue\r\n\t\t,bff_1.smg_accommodation_costs\r\n\t\t,bff_1.smg_early_booking_discounts\r\n\t\t,bff_1.smg_late_booking_discounts\r\n\t\t,bff_1.smg_flying_costs\r\n\t\t,bff_1.smg_other_costs\r\n\t\t,bff_1.smg_distribution_costs\r\n\t\t,bff_1.smg_non_margin_items\r\n\t\t,bff_1.smg_margin\r\n\t\t,bff_1.rep_currency\r\n\t\t,bff_1.rep_revenue\r\n\t\t,bff_1.rep_cnx_and_amend_revenue\r\n\t\t,bff_1.rep_accommodation_costs\r\n\t\t,bff_1.rep_early_booking_discounts\r\n\t\t,bff_1.rep_late_booking_discounts\r\n\t\t,bff_1.rep_flying_costs\r\n\t\t,bff_1.rep_other_costs\r\n\t\t,bff_1.rep_distribution_costs\r\n\t\t,bff_1.rep_non_margin_items\r\n\t\t,bff_1.rep_margin\r\n\tFROM opa_fl_uk.v_booking_fact_margin_uk bff_1\r\n)\r\n,booking_fact_1 AS (\r\n\tSELECT DISTINCT\r\n\t\tCASE WHEN bk.atcom_res_id IS NULL THEN NULL ELSE 'UKATCOM|' || bk.atcom_res_id END AS bk_booking\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All accom services cancelled\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t=\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\tTHEN\r\n\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t= 0\r\n\t\t\t\t\tTHEN 'U'\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t> 1\r\n\t\t\t\t\t\tTHEN 'MULTI'\r\n\r\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\r\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\t\tELSE\r\n\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t= 0\r\n\t\t\t\t\tTHEN 'U'\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t> 1\r\n\t\t\t\t\t\tTHEN 'MULTI'\r\n\r\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\r\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\tEND AS bk_primary_accom\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All accom services cancelled\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t=\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\tTHEN\r\n\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t= 0\r\n\t\t\t\t\tTHEN 'U'\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t> 1\r\n\t\t\t\t\t\tTHEN 'MULTI'\r\n\r\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\r\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\t\tELSE\r\n\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t= 0\r\n\t\t\t\t\tTHEN 'U'\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t> 1\r\n\t\t\t\t\t\tTHEN 'MULTI'\r\n\r\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\r\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\tEND AS bk_primary_room\r\n\t\t,COALESCE(\r\n\t\t\tCASE WHEN\r\n\t\t\t\tMIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) = MIN(bs.max_flight_id) OVER (PARTITION BY bk.atcom_res_id)\r\n\t\t\t\tAND COUNT(DISTINCT bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) > 1\r\n\t\t\t\t\tTHEN 'MULTI'\r\n\t\t\tWHEN\r\n\t\t\t\tMIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) = MIN(bs.max_flight_id) OVER (PARTITION BY bk.atcom_res_id)\r\n\t\t\t\tAND COUNT(DISTINCT bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) = 1\r\n\t\t\t\t\tTHEN 'UKATCOM|' || MIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id)\r\n\t\t\tWHEN SUM(bs.flight_out_count) OVER (PARTITION BY bk.atcom_res_id) > 1\r\n\t\t\t\tTHEN 'MULTI'\r\n\t\t\t\tELSE 'UKATCOM|' || MIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id)\r\n\t\t\tEND\r\n\t\t, 'U') AS bk_first_flight\r\n\t\t,COALESCE(\r\n\t\t\tCASE WHEN\r\n\t\t\t\tMIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) = MIN(bs.max_flight_id) OVER (PARTITION BY bk.atcom_res_id)\r\n\t\t\t\t\tTHEN NULL\r\n\t\t\tWHEN SUM(bs.flight_ret_count) OVER (PARTITION BY bk.atcom_res_id) > 1\r\n\t\t\t\tTHEN 'MULTI'\r\n\t\t\t\tELSE 'UKATCOM|' || MIN(bs.max_flight_id) OVER (PARTITION BY bk.atcom_res_id)\r\n\t\t\tEND\r\n\t\t, 'U') AS bk_last_flight\r\n\t\t,CASE WHEN ofn.cd IS NULL\r\n\t\t\tTHEN 'UKATCOM|U'\r\n\t\t\tELSE 'UKATCOM|' || ofn.cd\r\n\t\tEND AS bk_source_market\r\n\t\t,'UKATCOM' AS bk_originating_system\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- Third party flight\r\n\t\t\t\tSUM(CASE WHEN bs.tpf_indicator = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\t\tTHEN 'UKATCOM|3PF'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Accommodation and Flight Package\r\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 1\r\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|PKG' -- Granular code = 'PKGAF'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Cruise and Flight Package\r\n\t\t\t\tSUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 1\r\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) > 0\r\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGCF'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Cruise and Accommodation and Flight Package\r\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 1\r\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) > 0\r\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 1\r\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGCAF'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Multi Accommodation and Flight Package\r\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 1\r\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|PKG' -- Granular code = 'PKGMAF'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Multi Cruise and Flight Package\r\n\t\t\t\tSUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) > 1\r\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGMCF'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Multi Accommodation and One Cruise and Flight Package\r\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 1\r\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 1\r\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGMACF'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Multi Cruise and One Accommodation and Flight Package\r\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 1\r\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) > 1\r\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGMCAF'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Multi Accommodation and Multi Cruise and Flight Package\r\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 1\r\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) > 1\r\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGMAMCF'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Single Accommodation Only\r\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 1\r\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\r\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|ACC' -- Granular code = 'ACCA'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Multi Accommodation Only\r\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 1\r\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\r\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|ACC' -- Granular code = 'ACCMA'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Accommodation and Flight Other\r\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 1\r\n\t\t\t\t\tTHEN 'UKATCOM|PKG' -- Granular code = 'ACCOTH'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Flight Only Return Outbound First\r\n\t\t\t\tSUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND MIN(bs.flight_out_first_date) OVER (PARTITION BY bs.sk_booking_id) < MIN(bs.flight_ret_first_date) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTROF'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Flight Only Return Inbound First\r\n\t\t\t\tSUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND MIN(bs.flight_ret_first_date) OVER (PARTITION BY bs.sk_booking_id) < MIN(bs.flight_out_first_date) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTRIF'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Flight only same day return\r\n\t\t\t\tSUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND MIN(bs.flight_ret_first_date) OVER (PARTITION BY bs.sk_booking_id) = MIN(bs.flight_out_first_date) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTSDR'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Flight Only One Way Outbound\r\n\t\t\t\tSUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) = 0\r\n\t\t\t\tAND (SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTOBO'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Flight Only One Way Inbound\r\n\t\t\t\tSUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) = 0\r\n\t\t\t\tAND (SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTIBO'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Single Cruise Only\r\n\t\t\t\tSUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 1\r\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\r\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'CRUSGL'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Multi Cruise Only\r\n\t\t\t\tSUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) > 1\r\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'CRUMLT'\r\n\r\n\t\t\tWHEN\r\n\t\t\t\t-- Third party\r\n\t\t\t\tSUM(bs.thirdparty_count) OVER (PARTITION BY bs.sk_booking_id) > 0\r\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\r\n\t\t\t\tAND (SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\r\n\t\t\t\t\tTHEN 'UKATCOM|TPB' -- Granular code = 'TPB'\r\n\r\n\t\t\tELSE 'UKATCOM|OTH'\r\n\t\tEND AS bk_booking_type\r\n\t\t,CASE WHEN bk.booking_status IS NULL\r\n\t\t\tTHEN 'U'\r\n\t\t\tELSE 'UKATCOM|' || bk.booking_status\r\n\t\tEND AS bk_booking_status\r\n\t\t,bk.atcom_res_id AS source_booking_id\r\n\t\t,bk.atcom_res_version AS source_booking_version\r\n\t\t,COALESCE(CAST(bk.source_created_on AS TIMESTAMP), CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS booking_created_datetime\r\n\t\t,COALESCE(bk.confirmed_on, CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS booking_confirmed_datetime\r\n\t\t,COALESCE(bk.cancelled_on, CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS booking_cancelled_datetime\r\n\t\t,gs.group_season_code AS group_season\r\n\t\t,CASE WHEN bk.sk_season_id IS NULL OR bk.sk_season_id = -1 OR bk.sk_season_id = -2\r\n\t\t\tTHEN NULL\r\n\t\t\tELSE\r\n\t\t\t\tCASE WHEN SUBSTRING(bk.sk_season_id, 5, 2) = 01\r\n\t\t\t\t\tTHEN 'S' || SUBSTRING(bk.sk_season_id, 3, 2)\r\n\t\t\t\t\tELSE 'W' || SUBSTRING(bk.sk_season_id, 3, 2)\r\n\t\t\t\tEND\r\n\t\tEND AS sm_season\r\n\t\t,CASE WHEN uc.cd IS NULL\r\n\t\t\tTHEN NULL\r\n\t\t\tELSE 'UKATCOM|' || uc.cd\r\n\t\tEND AS channel_code\r\n\t\t,CASE WHEN uc.name IS NULL\r\n\t\t\tTHEN NULL\r\n\t\t\tELSE 'UKATCOM|' || uc.name\r\n\t\tEND AS channel_desc\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All accom services cancelled\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t=\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\tTHEN\r\n\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t= 0\r\n\t\t\t\t\tTHEN NULL\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t> 1\r\n\t\t\t\t\t\tTHEN 'MULTI'\r\n\r\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\r\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\t\tELSE\r\n\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t= 0\r\n\t\t\t\t\tTHEN NULL\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t> 1\r\n\t\t\t\t\t\tTHEN 'MULTI'\r\n\r\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\r\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\tEND AS booked_board_code\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All accom services cancelled\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t=\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\tTHEN\r\n\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t= 0\r\n\t\t\t\t\tTHEN NULL\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t> 1\r\n\t\t\t\t\t\tTHEN 'MULTI'\r\n\r\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\r\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_name ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_name ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\t\tELSE\r\n\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t= 0\r\n\t\t\t\t\tTHEN NULL\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tCASE WHEN\r\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t> 1\r\n\t\t\t\t\t\tTHEN 'MULTI'\r\n\r\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\r\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_name ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_name ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\tEND AS booked_board_name\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All accom services are cancelled\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t= SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\tTHEN\r\n\t\t\t\tCASE WHEN SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id) > 1\r\n\t\t\t\t\tTHEN 'Y'\r\n\t\t\t\t\tELSE 'N'\r\n\t\t\t\tEND\r\n\t\t\tELSE\r\n\t\t\t\tCASE WHEN SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id) > 1\r\n\t\t\t\t\tTHEN 'Y'\r\n\t\t\t\t\tELSE 'N'\r\n\t\t\t\tEND\r\n\t\tEND AS multi_room_booking\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All accom services are cancelled\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t= SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\tTHEN\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\tELSE\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\tEND AS number_of_booked_rooms\r\n\t\t,CASE WHEN\r\n\t\t\t\t-- All accom services are cancelled\r\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\t\t= SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\r\n\t\t\tTHEN\r\n\t\t\t\tCASE WHEN COUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id) > 1\r\n\t\t\t\t\tTHEN 'Y'\r\n\t\t\t\t\tELSE 'N'\r\n\t\t\t\tEND\r\n\t\t\tELSE\r\n\t\t\t\tCASE WHEN COUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id) > 1\r\n\t\t\t\t\tTHEN 'Y'\r\n\t\t\t\t\tELSE 'N'\r\n\t\t\t\tEND\r\n\t\tEND AS multi_centre_booking\r\n\t\t,COALESCE(bk.season_date,CAST('2999-12-31 23:59:59.0' AS DATE)) AS departure_date\r\n\t\t,COALESCE(\r\n\t\t\tbs.max_multi_center_date,\r\n\t\t\tbs.max_accom_date,\r\n\t\t\tbs.max_cruise_date,\r\n\t\t\tbs.max_flight_date,\r\n\t\t\tCAST('2999-12-31 23:59:59.0' AS DATE)\r\n\t\t) AS return_date\r\n\t\t,CASE WHEN\r\n\t\t\tCOALESCE(bk.season_date, CAST('2999-12-31 23:59:59.0' AS DATE)) = CAST('2999-12-31 23:59:59.0' AS DATE)\r\n\t\tOR\r\n\t\t\tCOALESCE(\r\n\t\t\t\tbs.max_multi_center_date,\r\n\t\t\t\tbs.max_accom_date,\r\n\t\t\t\tbs.max_cruise_date,\r\n\t\t\t\tbs.max_flight_date,\r\n\t\t\t\tCAST('2999-12-31 23:59:59.0' AS DATE)\r\n\t\t\t) = CAST('2999-12-31 23:59:59.0' AS DATE)\r\n\t\tTHEN 0\r\n\t\tELSE\r\n\t\t\tDATEDIFF('DAY',\r\n\t\t\t\tbk.season_date\r\n\t\t\t,\r\n\t\t\t\tCOALESCE(\r\n\t\t\t\t\tbs.max_multi_center_date,\r\n\t\t\t\t\tbs.max_accom_date,\r\n\t\t\t\t\tbs.max_cruise_date,\r\n\t\t\t\t\tbs.max_flight_date)\r\n\t\t\t)\r\n\t\tEND\tAS DURATION\r\n\t\t,COALESCE(bk.number_of_adults, 0) AS std_number_of_booking_adult_pax\r\n\t\t,COALESCE(bk.number_of_children, 0) AS std_number_of_booking_child_pax\r\n\t\t,COALESCE(bk.number_of_infants, 0) AS std_number_of_booking_infant_pax\r\n\t\t,COALESCE(bk.number_of_passengers, 0) AS std_number_of_booking_pax\r\n\t\t,COALESCE(bk.number_of_adults, 0) AS sm_number_of_booking_adult_pax\r\n\t\t,0 AS sm_number_of_booking_teenager_pax\r\n\t\t,COALESCE(bk.number_of_children, 0) AS sm_number_of_booking_child_pax\r\n\t\t,COALESCE(bk.number_of_infants, 0) AS sm_number_of_booking_infant_pax\r\n\t\t,COALESCE(bk.number_of_passengers, 0) AS sm_number_of_booking_pax\r\n\t\t,CASE WHEN COUNT(DISTINCT bs.min_flight_gateway) OVER (PARTITION BY bk.atcom_res_id) > 1\r\n\t\t\tTHEN 'MULTI'\r\n\t\t\tELSE MIN(bs.min_flight_gateway) OVER (PARTITION BY bk.atcom_res_id)\r\n\t\tEND AS primary_gateway\r\n\t\t,cur.name AS currency\r\n\t\t,COALESCE(bk.dwh_created_on, CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS sm_created_datetime\r\n\t\t,COALESCE(bk.dwh_modified_on, CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS sm_updated_datetime\r\n\t\t,CAST(CONVERT_TIMEZONE('Europe/London',CURRENT_TIMESTAMP()) AS TIMESTAMP_NTZ) AS dm_created_datetime\r\n\r\n\tFROM fl_acr_booking bk\r\n\tLEFT OUTER JOIN booking_service bs ON bk.sk_booking_id = bs.sk_booking_id AND bk.booking_version = bs.booking_version\r\n\r\n\t-- Group Season\r\n\tLEFT OUTER JOIN dates gs ON CAST(COALESCE(SUBSTRING(bk.season_date, 1, 4) || SUBSTRING(bk.season_date, 6, 2) || SUBSTRING(bk.season_date, 9, 2), 20991231) AS INTEGER) = gs.bk_date\r\n\r\n\t-- Market source\r\n\tLEFT OUTER JOIN ar_agent ag ON bk.atcom_agent_id = ag.agt_id\r\n\r\n      -- V1.06 Version of source market joins\r\n      LEFT OUTER JOIN ar_market m   ON bk.atcom_market_id = m.mkt_id\r\n      LEFT OUTER JOIN ar_officename ofn ON m.off_id = ofn.off_name_id\r\n\r\n\t-- Channel\r\n\tLEFT OUTER JOIN ar_usercodes uc ON ag.agt_tp_id = uc.user_cd_id\r\n\r\n\t-- Currency\r\n\tLEFT OUTER JOIN ar_currency cur ON bk.atcom_sell_currency_id = cur.cur_id\r\n\r\n\tWHERE bk_booking IS NOT NULL\r\n)\r\n\r\nSELECT\r\n\tbf.bk_booking,\r\n\tbf.bk_primary_accom,\r\n\tbf.bk_primary_room,\r\n\tbf.bk_first_flight,\r\n\tbf.bk_last_flight,\r\n\tbf.bk_source_market,\r\n\tbf.bk_originating_system,\r\n\tbf.bk_booking_type,\r\n\tbf.bk_booking_status,\r\n\tbf.source_booking_id,\r\n\tbf.source_booking_version,\r\n\tbf.booking_created_datetime,\r\n\tbf.booking_confirmed_datetime,\r\n\tbf.booking_cancelled_datetime,\r\n\tbf.group_season,\r\n\tbf.sm_season,\r\n\tbf.channel_code,\r\n\tbf.channel_desc,\r\n\tbf.booked_board_code,\r\n\tbf.booked_board_name,\r\n\tbf.multi_room_booking,\r\n\tbf.number_of_booked_rooms,\r\n\tbf.multi_centre_booking,\r\n\tbf.departure_date,\r\n\tbf.return_date,\r\n\tbf.duration,\r\n\tbf.std_number_of_booking_adult_pax,\r\n\tbf.std_number_of_booking_child_pax,\r\n\tbf.std_number_of_booking_infant_pax,\r\n\tbf.std_number_of_booking_pax,\r\n\tbf.sm_number_of_booking_adult_pax,\r\n\tbf.sm_number_of_booking_teenager_pax,\r\n\tbf.sm_number_of_booking_child_pax,\r\n\tbf.sm_number_of_booking_infant_pax,\r\n\tbf.sm_number_of_booking_pax,\r\n\tbf.primary_gateway,\r\n\t\tCOALESCE(bfm.sm_currency, fx.bk_sm_ccy, 'U') AS sm_currency,\r\n\tCOALESCE(bfm.sm_revenue, 0) AS sm_revenue,\r\n\tCOALESCE(bfm.sm_cnx_and_amend_revenue, 0) AS sm_cnx_and_amend_revenue,\r\n\tCOALESCE(bfm.sm_accommodation_costs, 0) AS sm_accommodation_costs,\r\n\tCOALESCE(bfm.sm_early_booking_discounts, 0) AS sm_early_booking_discounts,\r\n\tCOALESCE(bfm.sm_late_booking_discounts, 0) AS sm_late_booking_discounts,\r\n\tCOALESCE(bfm.sm_flying_costs, 0) AS sm_flying_costs,\r\n\tCOALESCE(bfm.sm_other_costs, 0) AS sm_other_costs,\r\n\tCOALESCE(bfm.sm_distribution_costs, 0) AS sm_distribution_costs,\r\n\tCOALESCE(bfm.sm_non_margin_items, 0) AS sm_non_margin_items,\r\n\tCOALESCE(bfm.sm_margin, 0) AS sm_margin,\r\n\tCOALESCE(bfm.smg_currency, fx.bk_smg_ccy, 'U') AS smg_currency,\r\n\tCOALESCE(bfm.smg_revenue, 0) AS smg_revenue,\r\n\tCOALESCE(bfm.smg_cnx_and_amend_revenue, 0) AS smg_cnx_and_amend_revenue,\r\n\tCOALESCE(bfm.smg_accommodation_costs, 0) AS smg_accommodation_costs,\r\n\tCOALESCE(bfm.smg_early_booking_discounts, 0) AS smg_early_booking_discounts,\r\n\tCOALESCE(bfm.smg_late_booking_discounts, 0) AS smg_late_booking_discounts,\r\n\tCOALESCE(bfm.smg_flying_costs, 0) AS smg_flying_costs,\r\n\tCOALESCE(bfm.smg_other_costs, 0) AS smg_other_costs,\r\n\tCOALESCE(bfm.smg_distribution_costs, 0) AS smg_distribution_costs,\r\n\tCOALESCE(bfm.smg_non_margin_items, 0) AS smg_non_margin_items,\r\n\tCOALESCE(bfm.smg_margin, 0) AS smg_margin,\r\n\tCOALESCE(bfm.rep_currency, fx.bk_rep_ccy, 'U') AS rep_currency,\r\n\tCOALESCE(bfm.rep_revenue, 0) AS rep_revenue,\r\n\tCOALESCE(bfm.rep_cnx_and_amend_revenue, 0) AS rep_cnx_and_amend_revenue,\r\n\tCOALESCE(bfm.rep_accommodation_costs, 0) AS rep_accommodation_costs,\r\n\tCOALESCE(bfm.rep_early_booking_discounts, 0) AS rep_early_booking_discounts,\r\n\tCOALESCE(bfm.rep_late_booking_discounts, 0) AS rep_late_booking_discounts,\r\n\tCOALESCE(bfm.rep_flying_costs, 0) AS rep_flying_costs,\r\n\tCOALESCE(bfm.rep_other_costs, 0) AS rep_other_costs,\r\n\tCOALESCE(bfm.rep_distribution_costs, 0) AS rep_distribution_costs,\r\n\tCOALESCE(bfm.rep_non_margin_items, 0) AS rep_non_margin_items,\r\n\tCOALESCE(bfm.rep_margin, 0) AS rep_margin,\r\n\tCOALESCE(bfm.ffd_flag, 'N') AS ffd_flag,\r\n\tbf.sm_created_datetime,\r\n\tbf.sm_updated_datetime,\r\n\tbf.dm_created_datetime\r\nFROM booking_fact_1 bf\r\nLEFT OUTER JOIN booking_fact_margin bfm ON bf.bk_booking = bfm.bk_booking\r\nLEFT OUTER JOIN opa_fl_all.source_market sm ON bf.bk_source_market = sm.bk_source_market\r\nLEFT OUTER JOIN opa_fl_uk.fx_rates_dim_uk fx\r\n\tON bf.sm_season = fx.bk_season\r\n\tAND sm.source_market_code = fx.source_market_code", "refs": [], "sources": [], "depends_on": {"nodes": [], "macros": []}, "unique_id": "model.dbt_test.v_booking_fact_uk", "empty": false, "fqn": ["dbt_test", "v_booking_fact_uk"], "tags": [], "config": {"enabled": true, "materialized": "view", "pre-hook": [], "post-hook": [], "tags": [], "column_types": {}, "vars": {}, "quoting": {}, "persist_docs": {}}, "schema": "DBT_TEST", "database": "OPA_DEV", "alias": "v_booking_fact_uk", "columns": {}, "description": "", "compiled": true, "compiled_sql": "\n\nWITH fl_acr_booking AS (\n\tSELECT\n\t\tbk_1.sk_booking_id\n\t\t,bk_1.booking_version\n\t\t,bk_1.atcom_res_id\n\t\t,bk_1.atcom_res_version\n    ,bk_1.atcom_market_id -- CG ADDED in V1.06 for new Source Market Derivation\n\t\t,bk_1.number_of_adults\n\t\t,bk_1.number_of_children\n\t\t,bk_1.number_of_infants\n\t\t,bk_1.number_of_passengers\n\t\t,bk_1.sk_season_id\n\t\t,bk_1.booking_status\n\t\t,bk_1.atcom_agent_id\n\t\t,bk_1.atcom_sell_currency_id\n\t\t,bk_1.season_date\n\t\t,bk_1.confirmed_on\n\t\t,bk_1.cancelled_on\n\t\t,bk_1.source_created_on\n\t\t,bk_1.modified_on\n\t\t,bk_1.dwh_created_on\n\t\t,bk_1.dwh_modified_on\n\n\tFROM opa_stg_uk.fl_acr_booking bk_1\n\tWHERE bk_1.file_dt = (SELECT MAX(bk_2.file_dt) FROM opa_stg_uk.fl_acr_booking bk_2 WHERE bk_1.sk_booking_id = bk_2.sk_booking_id AND bk_1.booking_version = bk_2.booking_version)\n\tAND bk_1.booking_version = (SELECT MAX(bk_3.booking_version) FROM opa_stg_uk.fl_acr_booking bk_3 WHERE bk_1.sk_booking_id = bk_3.sk_booking_id)\n\tAND (bk_1.sk_season_id > 201701 OR bk_1.sk_booking_id IS NULL)\n\n\t-- To be removed when running against all bookings\n\tAND bk_1.sk_booking_id IN ('380402','975528','10016009','10063844','15994298','22568921','25059884','27813713','28536240','30846203','33404409','20348866','31280892','35353771')\n)\n,ar_sellstatic AS (\n\tSELECT\n\t\tsls_1.sell_stc_id\n\t\t,sls_1.stc_stk_id\n\tFROM opa_stg_uk.ar_sellstatic sls_1\n\tWHERE sls_1.file_dt = (SELECT MAX(sls_2.file_dt) FROM opa_stg_uk.ar_sellstatic sls_2 WHERE sls_1.sell_stc_id = sls_2.sell_stc_id)\n)\n,ar_staticstock AS (\n\tSELECT\n\t\tss.stc_stk_id\n\t\t,ss.cd\n\tFROM opa_stg_uk.ar_staticstock ss\n\tWHERE ss.file_dt = (SELECT MAX(ss_2.file_dt) FROM opa_stg_uk.ar_staticstock ss_2 WHERE ss.stc_stk_id = ss_2.stc_stk_id)\n)\n,ar_staticroom AS (\n  SELECT\n\tsr.stc_rm_id\n\t,sr.stc_stk_id\n\t,sr.rm_id\n  FROM opa_stg_uk.ar_staticroom sr\n  WHERE sr.file_dt = (SELECT MAX(sr_2.file_dt) FROM opa_stg_uk.ar_staticroom sr_2 WHERE sr.stc_rm_id = sr_2.stc_rm_id)\n)\n,ar_sellunit AS (\n\tSELECT\n\t\tsu.sell_unit_id\n\t\t,su.rm_id\n\t\t,su.bb_cd_id\n\tFROM opa_stg_uk.ar_sellunit su\n\tWHERE su.file_dt = (SELECT MAX(su_2.file_dt) FROM opa_stg_uk.ar_sellunit su_2 WHERE su.sell_unit_id = su_2.sell_unit_id)\n)\n,ar_usercodes AS (\n\tSELECT DISTINCT\n\t\tuc_1.user_cd_id\n\t\t,uc_1.cd\n\t\t,uc_1.name\n\tFROM opa_stg_uk.ar_usercodes uc_1\n\tWHERE uc_1.file_dt = (SELECT MAX(uc_2.file_dt) FROM opa_stg_uk.ar_usercodes uc_2 WHERE uc_1.user_cd_id = uc_2.user_cd_id)\n)\n,fl_acr_booking_service AS (\n\tSELECT\n\t\tbk_ser_1.sk_booking_service_id\n\t\t,bk_ser_1.sk_booking_id\n\t\t,bk_ser_1.sk_service_id\n\t\t,bk_ser_1.service_version\n\t\t,bk_ser_1.booking_version\n\tFROM opa_stg_uk.fl_acr_booking_service bk_ser_1\n\tWHERE bk_ser_1.file_dt = (SELECT MAX(bk_ser_2.file_dt) FROM opa_stg_uk.fl_acr_booking_service bk_ser_2 WHERE bk_ser_1.sk_booking_service_id = bk_ser_2.sk_booking_service_id)\n\tAND bk_ser_1.booking_version = (SELECT MAX(bk_ser_3.booking_version) FROM opa_stg_uk.fl_acr_booking_service bk_ser_3 WHERE bk_ser_1.sk_booking_id = bk_ser_3.sk_booking_id)\n\tAND bk_ser_1.service_version = (SELECT MAX(bk_ser_4.service_version) FROM opa_stg_uk.fl_acr_booking_service bk_ser_4 WHERE bk_ser_1.sk_service_id = bk_ser_4.sk_service_id)\n\n\t-- To be removed when running against all bookings\n\tAND bk_ser_1.sk_booking_id IN ('380402','975528','10016009','10063844','15994298','22568921','25059884','27813713','28536240','30846203','33404409','20348866','31280892','35353771')\n)\n,fl_acr_service AS (\n\tSELECT\n\t\tser_1.sk_service_id\n\t\t,ser_1.atcom_ser_id\n\t\t,ser_1.atcom_dep_point_id\n\t\t,ser_1.service_version\n\t\t,ser_1.service_status\n\t\t,ser_1.direction\n\t\t,ser_1.sell_type\n\t\t,ser_1.service_type\n\t\t,ser_1.flight_type_code\n\t\t,ser_1.service_start_date1\n\t\t,ser_1.service_end_date1\n\t\t,ser_1.departure_flight_number\n\t\t,ser_1.atcom_arr_point_id\n\t\t,ser_1.source_stock_type_code\n\tFROM opa_stg_uk.fl_acr_service ser_1\n\tWHERE ser_1.file_dt = (SELECT MAX(ser_2.file_dt) FROM opa_stg_uk.fl_acr_service ser_2 WHERE ser_1.sk_service_id = ser_2.sk_service_id AND ser_1.service_version = ser_2.service_version)\n)\n,fl_acr_service_element AS (\n\tSELECT\n\t\tser_e_1.sk_service_id\n\t\t,ser_e_1.service_version\n\t\t,ser_e_1.atcom_sub_ser_id\n\tFROM opa_stg_uk.fl_acr_service_element ser_e_1\n\tWHERE ser_e_1.file_dt = (SELECT MAX(ser_e_2.file_dt) FROM opa_stg_uk.fl_acr_service_element ser_e_2 WHERE ser_e_1.sk_service_element_id = ser_e_2.sk_service_element_id)\n)\n,ar_transroute AS (\n\tSELECT\n\t\ttr.trans_route_id\n\t\t,tr.route_cd\n\tFROM opa_stg_uk.ar_transroute tr\n\tWHERE tr.file_dt = (SELECT MAX(tr_2.file_dt) FROM opa_stg_uk.ar_transroute tr_2 WHERE tr.trans_route_id = tr_2.trans_route_id)\n)\n,ar_transinvroute AS (\n\tSELECT\n\t\ttir.trans_inv_route_id\n\t\t,tir.trans_route_id\n\tFROM opa_stg_uk.ar_transinvroute tir\n\tWHERE tir.file_dt = (SELECT MAX(tir_2.file_dt) FROM opa_stg_uk.ar_transinvroute tir_2 WHERE tir.trans_inv_route_id = tir_2.trans_inv_route_id)\n)\n,ar_transinvroutesector AS (\n\tSELECT\n\t\ttirs.trans_inv_route_id\n\t\t,tirs.trans_inv_sec_id\n\t\t,tirs.trans_inv_route_sec_id\n\tFROM opa_stg_uk.ar_transinvroutesector tirs\n\tWHERE tirs.file_dt = (SELECT MAX(tirs_2.file_dt) FROM opa_stg_uk.ar_transinvroutesector tirs_2 WHERE tirs.trans_inv_route_sec_id = tirs_2.trans_inv_route_sec_id)\n),\nar_transinvsector AS (\n\tSELECT\n\t\ttis.trans_inv_sec_id\n\t\t,tis.dep_dt_tm\n\tFROM opa_stg_uk.ar_transinvsector tis\n\tWHERE tis.file_dt = (SELECT MAX(tis_2.file_dt) FROM opa_stg_uk.ar_transinvsector tis_2 WHERE tis.trans_inv_sec_id = tis_2.trans_inv_sec_id)\n)\n,ar_point AS (\n\tSELECT\n\t\tp.pt_id\n\t\t,p.pt_cd\n\tFROM opa_stg_uk.ar_point p\n\tWHERE p.file_dt = (SELECT MAX(p_2.file_dt) FROM opa_stg_uk.ar_point p_2 WHERE p.pt_id = p_2.pt_id)\n)\n,dates AS (\n\tSELECT\n\t\tdd.bk_date\n\t\t,dd.group_season_code\n\tFROM opa_stg_all.date_dim dd\n)\n,booking_service AS (\n\tSELECT\n\t\tbk_ser.sk_booking_id\n\t\t,bk_ser.booking_version\n\t\t,bk_ser.sk_service_id\n\t\t,bk_ser.service_version\n\t\t,bk_ser.sk_booking_service_id\n\t\t,ser.service_type\n\t\t,ser.source_stock_type_code\n\t\t,ser.sell_type\n\t\t,ser.service_status\n\t\t,ser.flight_type_code\n\t\t,ser.service_start_date1\n\t\t,ser.service_end_date1\n\t\t,tis.dep_dt_tm\n\t\t,ser.departure_flight_number\n\t\t,ser.direction\n\t\t,tr.route_cd\n\t\t,dpt.pt_cd\n\t\t,CASE WHEN\n\t\t\t-- All flight cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tCASE WHEN\n\t\t\t\tser.service_start_date1 =\n\t\t\t\t\tMIN(CASE WHEN\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\n\t\t\t\t\t\tTHEN ser.service_start_date1\n\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\tEND\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\tTHEN apt.pt_cd\n\t\t\t\tELSE NULL\n\t\t\tEND\n\t\tELSE\n\t\t\tCASE WHEN\n\t\t\t\tser.service_start_date1 =\n\t\t\t\t\tMIN(CASE WHEN\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\t\tTHEN ser.service_start_date1\n\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\tEND\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\tAND ser.service_status = 'CON'\n\t\t\t\tTHEN apt.pt_cd\n\t\t\t\tELSE NULL\n\t\t\tEND\n\t\tEND AS min_flight_gateway\n\n\t\t,CASE WHEN\n\t\t\t-- All flight cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tCASE WHEN\n\t\t\t\tser.service_start_date1 =\n\t\t\t\t\tMIN(CASE WHEN\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\n\t\t\t\t\t\tTHEN ser.service_start_date1\n\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\tEND\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\tTHEN\n\t\t\t\t\tCASE WHEN tr.route_cd IS NULL\n\t\t\t\t\t\tTHEN\n\t\t\t\t\t\t\tser.departure_flight_number|| '|' || dpt.pt_cd || '|' || apt.pt_cd|| '|' || CAST(SUBSTR(ser.service_start_date1,1,4)||SUBSTR(ser.service_start_date1,6,2)||SUBSTR(ser.service_start_date1,9,2) AS VARCHAR)\n\t\t\t\t\t\tELSE\n\t\t\t\t\t\t\ttr.route_cd || '|' || SUBSTRING(tis.dep_dt_tm, 1, 4) || SUBSTRING(tis.dep_dt_tm, 6, 2) || SUBSTRING(tis.dep_dt_tm, 9, 2)\n\t\t\t\t\t\tEND\n\t\t\t\tELSE NULL\n\t\t\tEND\n\t\tELSE\n\t\t\tCASE WHEN\n\t\t\t\tser.service_start_date1 =\n\t\t\t\t\tMIN(CASE WHEN\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\t\tTHEN ser.service_start_date1\n\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\tEND\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\tAND ser.service_status = 'CON'\n\t\t\t\tTHEN\n\t\t\t\t\tCASE WHEN tr.route_cd IS NULL\n\t\t\t\t\t\tTHEN\n\t\t\t\t\t\t\tser.departure_flight_number|| '|' || dpt.pt_cd || '|' || apt.pt_cd|| '|' || CAST(SUBSTR(ser.service_start_date1,1,4)||SUBSTR(ser.service_start_date1,6,2)||SUBSTR(ser.service_start_date1,9,2) AS VARCHAR)\n\t\t\t\t\t\tELSE\n\t\t\t\t\t\t\ttr.route_cd || '|' || SUBSTRING(tis.dep_dt_tm, 1, 4) || SUBSTRING(tis.dep_dt_tm, 6, 2) || SUBSTRING(tis.dep_dt_tm, 9, 2)\n\t\t\t\t\t\tEND\n\t\t\t\tELSE NULL\n\t\t\tEND\n\t\tEND\tAS min_flight_id\n\n\t\t,CASE WHEN\n\t\t\t-- All flight cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tCASE WHEN\n\t\t\t\tser.service_start_date1 =\n\t\t\t\t\tMAX(CASE WHEN\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\n\t\t\t\t\t\tTHEN ser.service_start_date1\n\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\tEND\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\tTHEN\n\t\t\t\t\tCASE WHEN tr.route_cd IS NULL\n\t\t\t\t\t\tTHEN\n\t\t\t\t\t\t\tser.departure_flight_number|| '|' || dpt.pt_cd || '|' || apt.pt_cd|| '|' || CAST(SUBSTR(ser.service_start_date1,1,4)||SUBSTR(ser.service_start_date1,6,2)||SUBSTR(ser.service_start_date1,9,2) AS VARCHAR)\n\t\t\t\t\t\tELSE\n\t\t\t\t\t\t\ttr.route_cd || '|' || SUBSTRING(tis.dep_dt_tm, 1, 4) || SUBSTRING(tis.dep_dt_tm, 6, 2) || SUBSTRING(tis.dep_dt_tm, 9, 2)\n\t\t\t\t\t\tEND\n\t\t\t\tELSE NULL\n\t\t\tEND\n\t\tELSE\n\t\t\tCASE WHEN\n\t\t\t\tser.service_start_date1 =\n\t\t\t\t\tMAX(CASE WHEN\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\t\tTHEN ser.service_start_date1\n\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\tEND\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\tAND ser.service_status = 'CON'\n\t\t\t\tTHEN\n\t\t\t\t\tCASE WHEN tr.route_cd IS NULL\n\t\t\t\t\t\tTHEN\n\t\t\t\t\t\t\tser.departure_flight_number|| '|' || dpt.pt_cd || '|' || apt.pt_cd|| '|' || CAST(SUBSTR(ser.service_start_date1,1,4)||SUBSTR(ser.service_start_date1,6,2)||SUBSTR(ser.service_start_date1,9,2) AS VARCHAR)\n\t\t\t\t\t\tELSE\n\t\t\t\t\t\t\ttr.route_cd || '|' || SUBSTRING(tis.dep_dt_tm, 1, 4) || SUBSTRING(tis.dep_dt_tm, 6, 2) || SUBSTRING(tis.dep_dt_tm, 9, 2)\n\t\t\t\t\t\tEND\n\t\t\t\tELSE NULL\n\t\t\tEND\n\t\tEND AS max_flight_id\n\n\n\t\t-- MULTICENTRE\n\t\t,CASE WHEN\n\t\t\t-- All multicentre services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM')\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CON')\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND\tAS min_multi_center_date\n\n\t\t,CASE WHEN\n\t\t\t-- All multicentre services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM')\n\t\t\t\tTHEN ser.service_end_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CON')\n\t\t\t\tTHEN ser.service_end_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND AS max_multi_center_date\n\n\n\t\t-- ACCOM\n\t\t,CASE WHEN\n\t\t\t-- All accom services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU'))\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM')\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CON')\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND AS min_accom_date\n\t\t,CASE WHEN\n\t\t\t-- All accom services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU'))\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM')\n\t\t\t\tTHEN ser.service_end_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CON')\n\t\t\t\tTHEN ser.service_end_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND AS max_accom_date\n\n\n\t\t-- CRUISE\n\t\t,CASE WHEN\n\t\t\t-- All accom services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'CRU')\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' AND ser.service_status = 'CON')\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND AS min_cruise_date\n\t\t,CASE WHEN\n\t\t\t-- All accom services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'CRU')\n\t\t\t\tTHEN ser.service_end_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' AND ser.service_status = 'CON')\n\t\t\t\tTHEN ser.service_end_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND max_cruise_date\n\n\n\t\t-- FLIGHT\n\t\t,CASE WHEN\n\t\t\t-- All flight services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\n\t\t\t\t--THEN tis.dep_dt_tm END)\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t--THEN tis.dep_dt_tm END)\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND AS min_flight_date\n\t\t,CASE WHEN\n\t\t\t-- All flight services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\n\t\t\t\t--THEN tis.dep_dt_tm END)\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t--THEN tis.dep_dt_tm END)\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND\tAS max_flight_date\n\n\t\t,sts.cd AS accom\n\t\t,su.bb_cd_id AS board_cd\n\t\t,uc_3.name AS board_name\n\t\t,str.stc_rm_id AS room\n\n\t\t-- Booking type derivation part 1\n\t\t,CASE WHEN\n\t\t\t\t-- No outbound flight services on the booking are third party\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) = 0\n\t\tTHEN 0\n\t\tELSE\n\t\t\tCASE WHEN\n\t\t\t\t-- All outbound flight services are 3PF\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t=\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\n\t\t\tOR\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' AND ser.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) > 1\n\t\t\tTHEN 1\n\t\t\tELSE 0\n\t\t\tEND\n\t\tEND AS tpf_out_count\n\t\t,CASE WHEN\n\t\t\t\t-- No outbound flight services on the booking are third party\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) = 0\n\t\tTHEN 0\n\t\tELSE\n\t\t\tCASE WHEN\n\t\t\t\t-- All outbound flight services are 3PF\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t=\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\n\t\t\tOR\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' AND ser.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) > 1\n\t\t\tTHEN 1\n\t\t\tELSE 0\n\t\t\tEND\n\t\tEND AS tpf_in_count\n\t\t,CASE WHEN\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\t-- No outbound flight services on the booking are third party\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) = 0\n\t\t\t\tTHEN 0\n\t\t\t\tELSE\n\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t-- All outbound flight services are 3PF\n\t\t\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\t\t=\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\n\t\t\t\t\tOR\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' AND ser.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) > 1\n\t\t\t\t\tTHEN 1\n\t\t\t\t\tELSE 0\n\t\t\t\t\tEND\n\t\t\t\tEND\n\t\t\t+\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\t-- No outbound flight services on the booking are third party\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) = 0\n\t\t\t\tTHEN 0\n\t\t\t\tELSE\n\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t-- All outbound flight services are 3PF\n\t\t\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\t\t=\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\n\t\t\t\t\tOR\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' AND ser.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) > 1\n\t\t\t\t\tTHEN 1\n\t\t\t\t\tELSE 0\n\t\t\t\t\tEND\n\t\t\t\tEND\n\t\t> 0\n\t\t\tTHEN 'Y'\n\t\t\tELSE 'N'\n\t\tEND AS tpf_indicator\n\t\t,CASE WHEN\n\t\t\t\t-- All accom cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') THEN 1 ELSE 0 END\n\t\t\tELSE CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CON' THEN 1 ELSE 0 END\n\t\tEND AS accom_count\n\t\t,CASE WHEN\n\t\t\t\t-- All cruise cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' THEN 1 ELSE 0 END\n\t\t\tELSE CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CON' THEN 1 ELSE 0 END\n\t\tEND AS cruise_count\n\t\t,CASE WHEN\n\t\t\t\t-- All flight out cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END\n\t\t\tELSE CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' AND ser.service_status = 'CON' THEN 1 ELSE 0 END\n\t\tEND AS flight_out_count\n\t\t,CASE WHEN\n\t\t\t\t-- All flight in cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END\n\t\t\tELSE CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' AND ser.service_status = 'CON' THEN 1 ELSE 0 END\n\t\tEND AS flight_ret_count\n\t\t,CASE WHEN\n\t\t\t\t-- All ahoc services cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'AHOC' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'AHOC' THEN 1 ELSE 0 END\n\t\t\tELSE CASE WHEN ser.service_type = 'AHOC' AND ser.service_status = 'CON' THEN 1 ELSE 0 END\n\t\tEND AS thirdparty_count\n\n\t\t,CASE WHEN\n\t\t\t\t-- All flight out first date cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN ser.service_start_date1 ELSE NULL END\n\t\t\tELSE CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' AND ser.service_status = 'CON' THEN ser.service_start_date1 ELSE NULL END\n\t\tEND AS flight_out_first_date\n\t\t,CASE WHEN\n\t\t\t\t-- All flight in first date cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN ser.service_start_date1 ELSE NULL END\n\t\t\tELSE CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' AND ser.service_status = 'CON' THEN ser.service_start_date1 ELSE NULL END\n\t\tEND AS flight_ret_first_date\n\n\t-- Service and subservice\n\tFROM fl_acr_booking_service bk_ser\n\tLEFT OUTER JOIN fl_acr_service ser ON bk_ser.sk_service_id = ser.sk_service_id AND bk_ser.service_version = ser.service_version\n\tLEFT OUTER JOIN fl_acr_service_element ser_e ON ser.sk_service_id = ser_e.sk_service_id AND ser.service_version = ser_e.service_version\n\n\t-- Accom\n\tLEFT OUTER JOIN ar_sellstatic sls ON ser.atcom_ser_id = sls.sell_stc_id\n\tLEFT OUTER JOIN ar_staticstock sts ON sls.stc_stk_id = sts.stc_stk_id\n\n\t-- Room\n\tLEFT OUTER JOIN ar_sellunit su ON ser_e.atcom_sub_ser_id = su.sell_unit_id\n\tLEFT OUTER JOIN ar_staticroom str ON sts.stc_stk_id = str.stc_stk_id AND su.rm_id = str.rm_id\n\n\t-- Board\n\tLEFT OUTER JOIN ar_usercodes uc_3 ON su.bb_cd_id = uc_3.user_cd_id\n\n\t-- Flight\n\tLEFT OUTER JOIN ar_transinvroute tir ON ser.atcom_ser_id = tir.trans_inv_route_id\n\tLEFT OUTER JOIN ar_transroute tr ON tir.trans_route_id = tr.trans_route_id\n\tLEFT OUTER JOIN ar_transinvroutesector tirs ON tir.trans_inv_route_id = tirs.trans_inv_route_id\n      LEFT OUTER JOIN ar_transinvsector tis ON tirs.trans_inv_sec_id = tis.trans_inv_sec_id\n\tLEFT OUTER JOIN ar_point dpt ON ser.atcom_dep_point_id = dpt.pt_id\n\tLEFT OUTER JOIN ar_point apt ON ser.atcom_arr_point_id = apt.pt_id\n\n\tORDER BY\n\t\tbk_ser.sk_booking_id\n\t\t,bk_ser.booking_version\n\t\t,ser.source_stock_type_code\n\n)\n,ar_agent AS (\n\tSELECT DISTINCT\n\t\tag_1.agt_id\n\t\t,ag_1.def_mkt_id\n\t\t,ag_1.agt_tp_id\n\tFROM opa_stg_uk.ar_agent ag_1\n\tWHERE ag_1.file_dt = (SELECT MAX(ag_2.file_dt) FROM opa_stg_uk.ar_agent ag_2 WHERE ag_1.agt_id = ag_2.agt_id)\n)\n,ar_market AS (\n\tSELECT DISTINCT\n\t\tmk_1.mkt_id\n\t\t,mk_1.off_id\n\tFROM opa_stg_uk.ar_market mk_1\n\tWHERE mk_1.file_dt = (SELECT MAX(mk_2.file_dt) FROM opa_stg_uk.ar_market mk_2 WHERE mk_1.mkt_id = mk_2.mkt_id)\n)\n,ar_officename AS (\n\tSELECT DISTINCT\n\t\tofn_1.off_name_id\n\t\t,ofn_1.cd\n\t\t,ofn_1.name\n\t\t-- ,sm.source_market_code\n\tFROM opa_stg_uk.ar_officename ofn_1\n\t-- LEFT OUTER JOIN opa_stg_all.source_market sm ON 'UKATCOM|' || ofn_1.cd = bk_source_market\n\tWHERE ofn_1.file_dt = (SELECT MAX(ofn_2.file_dt) FROM opa_stg_uk.ar_officename ofn_2 WHERE ofn_1.off_name_id = ofn_2.off_name_id)\n)\n,ar_currency AS (\n\tSELECT DISTINCT\n\t\tcur_1.cur_id\n\t\t,cur_1.cd\n\t\t,cur_1.name\n\tFROM opa_stg_uk.ar_currency cur_1\n\tWHERE cur_1.file_dt = (SELECT MAX(cur_2.file_dt) FROM opa_stg_uk.ar_currency cur_2 WHERE cur_1.cur_id = cur_2.cur_id)\n)\n\t,booking_fact_margin AS (\n\tSELECT\n\t\tbff_1.bk_booking\n\t\t,bff_1.ffd_flag\n\t\t,bff_1.sm_currency\n\t\t,bff_1.sm_revenue\n\t\t,bff_1.sm_cnx_and_amend_revenue\n\t\t,bff_1.sm_accommodation_costs\n\t\t,bff_1.sm_early_booking_discounts\n\t\t,bff_1.sm_late_booking_discounts\n\t\t,bff_1.sm_flying_costs\n\t\t,bff_1.sm_other_costs\n\t\t,bff_1.sm_distribution_costs\n\t\t,bff_1.sm_non_margin_items\n\t\t,bff_1.sm_margin\n\t\t,bff_1.smg_currency\n\t\t,bff_1.smg_revenue\n\t\t,bff_1.smg_cnx_and_amend_revenue\n\t\t,bff_1.smg_accommodation_costs\n\t\t,bff_1.smg_early_booking_discounts\n\t\t,bff_1.smg_late_booking_discounts\n\t\t,bff_1.smg_flying_costs\n\t\t,bff_1.smg_other_costs\n\t\t,bff_1.smg_distribution_costs\n\t\t,bff_1.smg_non_margin_items\n\t\t,bff_1.smg_margin\n\t\t,bff_1.rep_currency\n\t\t,bff_1.rep_revenue\n\t\t,bff_1.rep_cnx_and_amend_revenue\n\t\t,bff_1.rep_accommodation_costs\n\t\t,bff_1.rep_early_booking_discounts\n\t\t,bff_1.rep_late_booking_discounts\n\t\t,bff_1.rep_flying_costs\n\t\t,bff_1.rep_other_costs\n\t\t,bff_1.rep_distribution_costs\n\t\t,bff_1.rep_non_margin_items\n\t\t,bff_1.rep_margin\n\tFROM opa_fl_uk.v_booking_fact_margin_uk bff_1\n)\n,booking_fact_1 AS (\n\tSELECT DISTINCT\n\t\tCASE WHEN bk.atcom_res_id IS NULL THEN NULL ELSE 'UKATCOM|' || bk.atcom_res_id END AS bk_booking\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t=\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN 'U'\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN 'U'\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\tEND AS bk_primary_accom\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t=\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN 'U'\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN 'U'\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\tEND AS bk_primary_room\n\t\t,COALESCE(\n\t\t\tCASE WHEN\n\t\t\t\tMIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) = MIN(bs.max_flight_id) OVER (PARTITION BY bk.atcom_res_id)\n\t\t\t\tAND COUNT(DISTINCT bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) > 1\n\t\t\t\t\tTHEN 'MULTI'\n\t\t\tWHEN\n\t\t\t\tMIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) = MIN(bs.max_flight_id) OVER (PARTITION BY bk.atcom_res_id)\n\t\t\t\tAND COUNT(DISTINCT bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) = 1\n\t\t\t\t\tTHEN 'UKATCOM|' || MIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id)\n\t\t\tWHEN SUM(bs.flight_out_count) OVER (PARTITION BY bk.atcom_res_id) > 1\n\t\t\t\tTHEN 'MULTI'\n\t\t\t\tELSE 'UKATCOM|' || MIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id)\n\t\t\tEND\n\t\t, 'U') AS bk_first_flight\n\t\t,COALESCE(\n\t\t\tCASE WHEN\n\t\t\t\tMIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) = MIN(bs.max_flight_id) OVER (PARTITION BY bk.atcom_res_id)\n\t\t\t\t\tTHEN NULL\n\t\t\tWHEN SUM(bs.flight_ret_count) OVER (PARTITION BY bk.atcom_res_id) > 1\n\t\t\t\tTHEN 'MULTI'\n\t\t\t\tELSE 'UKATCOM|' || MIN(bs.max_flight_id) OVER (PARTITION BY bk.atcom_res_id)\n\t\t\tEND\n\t\t, 'U') AS bk_last_flight\n\t\t,CASE WHEN ofn.cd IS NULL\n\t\t\tTHEN 'UKATCOM|U'\n\t\t\tELSE 'UKATCOM|' || ofn.cd\n\t\tEND AS bk_source_market\n\t\t,'UKATCOM' AS bk_originating_system\n\t\t,CASE WHEN\n\t\t\t\t-- Third party flight\n\t\t\t\tSUM(CASE WHEN bs.tpf_indicator = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\t\tTHEN 'UKATCOM|3PF'\n\n\t\t\tWHEN\n\t\t\t\t-- Accommodation and Flight Package\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|PKG' -- Granular code = 'PKGAF'\n\n\t\t\tWHEN\n\t\t\t\t-- Cruise and Flight Package\n\t\t\t\tSUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) > 0\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGCF'\n\n\t\t\tWHEN\n\t\t\t\t-- Cruise and Accommodation and Flight Package\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) > 0\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGCAF'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Accommodation and Flight Package\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|PKG' -- Granular code = 'PKGMAF'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Cruise and Flight Package\n\t\t\t\tSUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGMCF'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Accommodation and One Cruise and Flight Package\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGMACF'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Cruise and One Accommodation and Flight Package\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGMCAF'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Accommodation and Multi Cruise and Flight Package\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGMAMCF'\n\n\t\t\tWHEN\n\t\t\t\t-- Single Accommodation Only\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|ACC' -- Granular code = 'ACCA'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Accommodation Only\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|ACC' -- Granular code = 'ACCMA'\n\n\t\t\tWHEN\n\t\t\t\t-- Accommodation and Flight Other\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 1\n\t\t\t\t\tTHEN 'UKATCOM|PKG' -- Granular code = 'ACCOTH'\n\n\t\t\tWHEN\n\t\t\t\t-- Flight Only Return Outbound First\n\t\t\t\tSUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND MIN(bs.flight_out_first_date) OVER (PARTITION BY bs.sk_booking_id) < MIN(bs.flight_ret_first_date) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTROF'\n\n\t\t\tWHEN\n\t\t\t\t-- Flight Only Return Inbound First\n\t\t\t\tSUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND MIN(bs.flight_ret_first_date) OVER (PARTITION BY bs.sk_booking_id) < MIN(bs.flight_out_first_date) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTRIF'\n\n\t\t\tWHEN\n\t\t\t\t-- Flight only same day return\n\t\t\t\tSUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND MIN(bs.flight_ret_first_date) OVER (PARTITION BY bs.sk_booking_id) = MIN(bs.flight_out_first_date) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTSDR'\n\n\t\t\tWHEN\n\t\t\t\t-- Flight Only One Way Outbound\n\t\t\t\tSUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\tAND (SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTOBO'\n\n\t\t\tWHEN\n\t\t\t\t-- Flight Only One Way Inbound\n\t\t\t\tSUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\tAND (SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTIBO'\n\n\t\t\tWHEN\n\t\t\t\t-- Single Cruise Only\n\t\t\t\tSUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'CRUSGL'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Cruise Only\n\t\t\t\tSUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'CRUMLT'\n\n\t\t\tWHEN\n\t\t\t\t-- Third party\n\t\t\t\tSUM(bs.thirdparty_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\tAND (SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\t\tTHEN 'UKATCOM|TPB' -- Granular code = 'TPB'\n\n\t\t\tELSE 'UKATCOM|OTH'\n\t\tEND AS bk_booking_type\n\t\t,CASE WHEN bk.booking_status IS NULL\n\t\t\tTHEN 'U'\n\t\t\tELSE 'UKATCOM|' || bk.booking_status\n\t\tEND AS bk_booking_status\n\t\t,bk.atcom_res_id AS source_booking_id\n\t\t,bk.atcom_res_version AS source_booking_version\n\t\t,COALESCE(CAST(bk.source_created_on AS TIMESTAMP), CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS booking_created_datetime\n\t\t,COALESCE(bk.confirmed_on, CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS booking_confirmed_datetime\n\t\t,COALESCE(bk.cancelled_on, CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS booking_cancelled_datetime\n\t\t,gs.group_season_code AS group_season\n\t\t,CASE WHEN bk.sk_season_id IS NULL OR bk.sk_season_id = -1 OR bk.sk_season_id = -2\n\t\t\tTHEN NULL\n\t\t\tELSE\n\t\t\t\tCASE WHEN SUBSTRING(bk.sk_season_id, 5, 2) = 01\n\t\t\t\t\tTHEN 'S' || SUBSTRING(bk.sk_season_id, 3, 2)\n\t\t\t\t\tELSE 'W' || SUBSTRING(bk.sk_season_id, 3, 2)\n\t\t\t\tEND\n\t\tEND AS sm_season\n\t\t,CASE WHEN uc.cd IS NULL\n\t\t\tTHEN NULL\n\t\t\tELSE 'UKATCOM|' || uc.cd\n\t\tEND AS channel_code\n\t\t,CASE WHEN uc.name IS NULL\n\t\t\tTHEN NULL\n\t\t\tELSE 'UKATCOM|' || uc.name\n\t\tEND AS channel_desc\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t=\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN NULL\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN NULL\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\tEND AS booked_board_code\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t=\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN NULL\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_name ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_name ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN NULL\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_name ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_name ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\tEND AS booked_board_name\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services are cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tCASE WHEN SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\t\tTHEN 'Y'\n\t\t\t\t\tELSE 'N'\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tCASE WHEN SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\t\tTHEN 'Y'\n\t\t\t\t\tELSE 'N'\n\t\t\t\tEND\n\t\tEND AS multi_room_booking\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services are cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tELSE\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\tEND AS number_of_booked_rooms\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services are cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tCASE WHEN COUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\t\tTHEN 'Y'\n\t\t\t\t\tELSE 'N'\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tCASE WHEN COUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\t\tTHEN 'Y'\n\t\t\t\t\tELSE 'N'\n\t\t\t\tEND\n\t\tEND AS multi_centre_booking\n\t\t,COALESCE(bk.season_date,CAST('2999-12-31 23:59:59.0' AS DATE)) AS departure_date\n\t\t,COALESCE(\n\t\t\tbs.max_multi_center_date,\n\t\t\tbs.max_accom_date,\n\t\t\tbs.max_cruise_date,\n\t\t\tbs.max_flight_date,\n\t\t\tCAST('2999-12-31 23:59:59.0' AS DATE)\n\t\t) AS return_date\n\t\t,CASE WHEN\n\t\t\tCOALESCE(bk.season_date, CAST('2999-12-31 23:59:59.0' AS DATE)) = CAST('2999-12-31 23:59:59.0' AS DATE)\n\t\tOR\n\t\t\tCOALESCE(\n\t\t\t\tbs.max_multi_center_date,\n\t\t\t\tbs.max_accom_date,\n\t\t\t\tbs.max_cruise_date,\n\t\t\t\tbs.max_flight_date,\n\t\t\t\tCAST('2999-12-31 23:59:59.0' AS DATE)\n\t\t\t) = CAST('2999-12-31 23:59:59.0' AS DATE)\n\t\tTHEN 0\n\t\tELSE\n\t\t\tDATEDIFF('DAY',\n\t\t\t\tbk.season_date\n\t\t\t,\n\t\t\t\tCOALESCE(\n\t\t\t\t\tbs.max_multi_center_date,\n\t\t\t\t\tbs.max_accom_date,\n\t\t\t\t\tbs.max_cruise_date,\n\t\t\t\t\tbs.max_flight_date)\n\t\t\t)\n\t\tEND\tAS DURATION\n\t\t,COALESCE(bk.number_of_adults, 0) AS std_number_of_booking_adult_pax\n\t\t,COALESCE(bk.number_of_children, 0) AS std_number_of_booking_child_pax\n\t\t,COALESCE(bk.number_of_infants, 0) AS std_number_of_booking_infant_pax\n\t\t,COALESCE(bk.number_of_passengers, 0) AS std_number_of_booking_pax\n\t\t,COALESCE(bk.number_of_adults, 0) AS sm_number_of_booking_adult_pax\n\t\t,0 AS sm_number_of_booking_teenager_pax\n\t\t,COALESCE(bk.number_of_children, 0) AS sm_number_of_booking_child_pax\n\t\t,COALESCE(bk.number_of_infants, 0) AS sm_number_of_booking_infant_pax\n\t\t,COALESCE(bk.number_of_passengers, 0) AS sm_number_of_booking_pax\n\t\t,CASE WHEN COUNT(DISTINCT bs.min_flight_gateway) OVER (PARTITION BY bk.atcom_res_id) > 1\n\t\t\tTHEN 'MULTI'\n\t\t\tELSE MIN(bs.min_flight_gateway) OVER (PARTITION BY bk.atcom_res_id)\n\t\tEND AS primary_gateway\n\t\t,cur.name AS currency\n\t\t,COALESCE(bk.dwh_created_on, CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS sm_created_datetime\n\t\t,COALESCE(bk.dwh_modified_on, CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS sm_updated_datetime\n\t\t,CAST(CONVERT_TIMEZONE('Europe/London',CURRENT_TIMESTAMP()) AS TIMESTAMP_NTZ) AS dm_created_datetime\n\n\tFROM fl_acr_booking bk\n\tLEFT OUTER JOIN booking_service bs ON bk.sk_booking_id = bs.sk_booking_id AND bk.booking_version = bs.booking_version\n\n\t-- Group Season\n\tLEFT OUTER JOIN dates gs ON CAST(COALESCE(SUBSTRING(bk.season_date, 1, 4) || SUBSTRING(bk.season_date, 6, 2) || SUBSTRING(bk.season_date, 9, 2), 20991231) AS INTEGER) = gs.bk_date\n\n\t-- Market source\n\tLEFT OUTER JOIN ar_agent ag ON bk.atcom_agent_id = ag.agt_id\n\n      -- V1.06 Version of source market joins\n      LEFT OUTER JOIN ar_market m   ON bk.atcom_market_id = m.mkt_id\n      LEFT OUTER JOIN ar_officename ofn ON m.off_id = ofn.off_name_id\n\n\t-- Channel\n\tLEFT OUTER JOIN ar_usercodes uc ON ag.agt_tp_id = uc.user_cd_id\n\n\t-- Currency\n\tLEFT OUTER JOIN ar_currency cur ON bk.atcom_sell_currency_id = cur.cur_id\n\n\tWHERE bk_booking IS NOT NULL\n)\n\nSELECT\n\tbf.bk_booking,\n\tbf.bk_primary_accom,\n\tbf.bk_primary_room,\n\tbf.bk_first_flight,\n\tbf.bk_last_flight,\n\tbf.bk_source_market,\n\tbf.bk_originating_system,\n\tbf.bk_booking_type,\n\tbf.bk_booking_status,\n\tbf.source_booking_id,\n\tbf.source_booking_version,\n\tbf.booking_created_datetime,\n\tbf.booking_confirmed_datetime,\n\tbf.booking_cancelled_datetime,\n\tbf.group_season,\n\tbf.sm_season,\n\tbf.channel_code,\n\tbf.channel_desc,\n\tbf.booked_board_code,\n\tbf.booked_board_name,\n\tbf.multi_room_booking,\n\tbf.number_of_booked_rooms,\n\tbf.multi_centre_booking,\n\tbf.departure_date,\n\tbf.return_date,\n\tbf.duration,\n\tbf.std_number_of_booking_adult_pax,\n\tbf.std_number_of_booking_child_pax,\n\tbf.std_number_of_booking_infant_pax,\n\tbf.std_number_of_booking_pax,\n\tbf.sm_number_of_booking_adult_pax,\n\tbf.sm_number_of_booking_teenager_pax,\n\tbf.sm_number_of_booking_child_pax,\n\tbf.sm_number_of_booking_infant_pax,\n\tbf.sm_number_of_booking_pax,\n\tbf.primary_gateway,\n\t\tCOALESCE(bfm.sm_currency, fx.bk_sm_ccy, 'U') AS sm_currency,\n\tCOALESCE(bfm.sm_revenue, 0) AS sm_revenue,\n\tCOALESCE(bfm.sm_cnx_and_amend_revenue, 0) AS sm_cnx_and_amend_revenue,\n\tCOALESCE(bfm.sm_accommodation_costs, 0) AS sm_accommodation_costs,\n\tCOALESCE(bfm.sm_early_booking_discounts, 0) AS sm_early_booking_discounts,\n\tCOALESCE(bfm.sm_late_booking_discounts, 0) AS sm_late_booking_discounts,\n\tCOALESCE(bfm.sm_flying_costs, 0) AS sm_flying_costs,\n\tCOALESCE(bfm.sm_other_costs, 0) AS sm_other_costs,\n\tCOALESCE(bfm.sm_distribution_costs, 0) AS sm_distribution_costs,\n\tCOALESCE(bfm.sm_non_margin_items, 0) AS sm_non_margin_items,\n\tCOALESCE(bfm.sm_margin, 0) AS sm_margin,\n\tCOALESCE(bfm.smg_currency, fx.bk_smg_ccy, 'U') AS smg_currency,\n\tCOALESCE(bfm.smg_revenue, 0) AS smg_revenue,\n\tCOALESCE(bfm.smg_cnx_and_amend_revenue, 0) AS smg_cnx_and_amend_revenue,\n\tCOALESCE(bfm.smg_accommodation_costs, 0) AS smg_accommodation_costs,\n\tCOALESCE(bfm.smg_early_booking_discounts, 0) AS smg_early_booking_discounts,\n\tCOALESCE(bfm.smg_late_booking_discounts, 0) AS smg_late_booking_discounts,\n\tCOALESCE(bfm.smg_flying_costs, 0) AS smg_flying_costs,\n\tCOALESCE(bfm.smg_other_costs, 0) AS smg_other_costs,\n\tCOALESCE(bfm.smg_distribution_costs, 0) AS smg_distribution_costs,\n\tCOALESCE(bfm.smg_non_margin_items, 0) AS smg_non_margin_items,\n\tCOALESCE(bfm.smg_margin, 0) AS smg_margin,\n\tCOALESCE(bfm.rep_currency, fx.bk_rep_ccy, 'U') AS rep_currency,\n\tCOALESCE(bfm.rep_revenue, 0) AS rep_revenue,\n\tCOALESCE(bfm.rep_cnx_and_amend_revenue, 0) AS rep_cnx_and_amend_revenue,\n\tCOALESCE(bfm.rep_accommodation_costs, 0) AS rep_accommodation_costs,\n\tCOALESCE(bfm.rep_early_booking_discounts, 0) AS rep_early_booking_discounts,\n\tCOALESCE(bfm.rep_late_booking_discounts, 0) AS rep_late_booking_discounts,\n\tCOALESCE(bfm.rep_flying_costs, 0) AS rep_flying_costs,\n\tCOALESCE(bfm.rep_other_costs, 0) AS rep_other_costs,\n\tCOALESCE(bfm.rep_distribution_costs, 0) AS rep_distribution_costs,\n\tCOALESCE(bfm.rep_non_margin_items, 0) AS rep_non_margin_items,\n\tCOALESCE(bfm.rep_margin, 0) AS rep_margin,\n\tCOALESCE(bfm.ffd_flag, 'N') AS ffd_flag,\n\tbf.sm_created_datetime,\n\tbf.sm_updated_datetime,\n\tbf.dm_created_datetime\nFROM booking_fact_1 bf\nLEFT OUTER JOIN booking_fact_margin bfm ON bf.bk_booking = bfm.bk_booking\nLEFT OUTER JOIN opa_fl_all.source_market sm ON bf.bk_source_market = sm.bk_source_market\nLEFT OUTER JOIN opa_fl_uk.fx_rates_dim_uk fx\n\tON bf.sm_season = fx.bk_season\n\tAND sm.source_market_code = fx.source_market_code", "extra_ctes_injected": true, "extra_ctes": [], "injected_sql": "\n\nWITH fl_acr_booking AS (\n\tSELECT\n\t\tbk_1.sk_booking_id\n\t\t,bk_1.booking_version\n\t\t,bk_1.atcom_res_id\n\t\t,bk_1.atcom_res_version\n    ,bk_1.atcom_market_id -- CG ADDED in V1.06 for new Source Market Derivation\n\t\t,bk_1.number_of_adults\n\t\t,bk_1.number_of_children\n\t\t,bk_1.number_of_infants\n\t\t,bk_1.number_of_passengers\n\t\t,bk_1.sk_season_id\n\t\t,bk_1.booking_status\n\t\t,bk_1.atcom_agent_id\n\t\t,bk_1.atcom_sell_currency_id\n\t\t,bk_1.season_date\n\t\t,bk_1.confirmed_on\n\t\t,bk_1.cancelled_on\n\t\t,bk_1.source_created_on\n\t\t,bk_1.modified_on\n\t\t,bk_1.dwh_created_on\n\t\t,bk_1.dwh_modified_on\n\n\tFROM opa_stg_uk.fl_acr_booking bk_1\n\tWHERE bk_1.file_dt = (SELECT MAX(bk_2.file_dt) FROM opa_stg_uk.fl_acr_booking bk_2 WHERE bk_1.sk_booking_id = bk_2.sk_booking_id AND bk_1.booking_version = bk_2.booking_version)\n\tAND bk_1.booking_version = (SELECT MAX(bk_3.booking_version) FROM opa_stg_uk.fl_acr_booking bk_3 WHERE bk_1.sk_booking_id = bk_3.sk_booking_id)\n\tAND (bk_1.sk_season_id > 201701 OR bk_1.sk_booking_id IS NULL)\n\n\t-- To be removed when running against all bookings\n\tAND bk_1.sk_booking_id IN ('380402','975528','10016009','10063844','15994298','22568921','25059884','27813713','28536240','30846203','33404409','20348866','31280892','35353771')\n)\n,ar_sellstatic AS (\n\tSELECT\n\t\tsls_1.sell_stc_id\n\t\t,sls_1.stc_stk_id\n\tFROM opa_stg_uk.ar_sellstatic sls_1\n\tWHERE sls_1.file_dt = (SELECT MAX(sls_2.file_dt) FROM opa_stg_uk.ar_sellstatic sls_2 WHERE sls_1.sell_stc_id = sls_2.sell_stc_id)\n)\n,ar_staticstock AS (\n\tSELECT\n\t\tss.stc_stk_id\n\t\t,ss.cd\n\tFROM opa_stg_uk.ar_staticstock ss\n\tWHERE ss.file_dt = (SELECT MAX(ss_2.file_dt) FROM opa_stg_uk.ar_staticstock ss_2 WHERE ss.stc_stk_id = ss_2.stc_stk_id)\n)\n,ar_staticroom AS (\n  SELECT\n\tsr.stc_rm_id\n\t,sr.stc_stk_id\n\t,sr.rm_id\n  FROM opa_stg_uk.ar_staticroom sr\n  WHERE sr.file_dt = (SELECT MAX(sr_2.file_dt) FROM opa_stg_uk.ar_staticroom sr_2 WHERE sr.stc_rm_id = sr_2.stc_rm_id)\n)\n,ar_sellunit AS (\n\tSELECT\n\t\tsu.sell_unit_id\n\t\t,su.rm_id\n\t\t,su.bb_cd_id\n\tFROM opa_stg_uk.ar_sellunit su\n\tWHERE su.file_dt = (SELECT MAX(su_2.file_dt) FROM opa_stg_uk.ar_sellunit su_2 WHERE su.sell_unit_id = su_2.sell_unit_id)\n)\n,ar_usercodes AS (\n\tSELECT DISTINCT\n\t\tuc_1.user_cd_id\n\t\t,uc_1.cd\n\t\t,uc_1.name\n\tFROM opa_stg_uk.ar_usercodes uc_1\n\tWHERE uc_1.file_dt = (SELECT MAX(uc_2.file_dt) FROM opa_stg_uk.ar_usercodes uc_2 WHERE uc_1.user_cd_id = uc_2.user_cd_id)\n)\n,fl_acr_booking_service AS (\n\tSELECT\n\t\tbk_ser_1.sk_booking_service_id\n\t\t,bk_ser_1.sk_booking_id\n\t\t,bk_ser_1.sk_service_id\n\t\t,bk_ser_1.service_version\n\t\t,bk_ser_1.booking_version\n\tFROM opa_stg_uk.fl_acr_booking_service bk_ser_1\n\tWHERE bk_ser_1.file_dt = (SELECT MAX(bk_ser_2.file_dt) FROM opa_stg_uk.fl_acr_booking_service bk_ser_2 WHERE bk_ser_1.sk_booking_service_id = bk_ser_2.sk_booking_service_id)\n\tAND bk_ser_1.booking_version = (SELECT MAX(bk_ser_3.booking_version) FROM opa_stg_uk.fl_acr_booking_service bk_ser_3 WHERE bk_ser_1.sk_booking_id = bk_ser_3.sk_booking_id)\n\tAND bk_ser_1.service_version = (SELECT MAX(bk_ser_4.service_version) FROM opa_stg_uk.fl_acr_booking_service bk_ser_4 WHERE bk_ser_1.sk_service_id = bk_ser_4.sk_service_id)\n\n\t-- To be removed when running against all bookings\n\tAND bk_ser_1.sk_booking_id IN ('380402','975528','10016009','10063844','15994298','22568921','25059884','27813713','28536240','30846203','33404409','20348866','31280892','35353771')\n)\n,fl_acr_service AS (\n\tSELECT\n\t\tser_1.sk_service_id\n\t\t,ser_1.atcom_ser_id\n\t\t,ser_1.atcom_dep_point_id\n\t\t,ser_1.service_version\n\t\t,ser_1.service_status\n\t\t,ser_1.direction\n\t\t,ser_1.sell_type\n\t\t,ser_1.service_type\n\t\t,ser_1.flight_type_code\n\t\t,ser_1.service_start_date1\n\t\t,ser_1.service_end_date1\n\t\t,ser_1.departure_flight_number\n\t\t,ser_1.atcom_arr_point_id\n\t\t,ser_1.source_stock_type_code\n\tFROM opa_stg_uk.fl_acr_service ser_1\n\tWHERE ser_1.file_dt = (SELECT MAX(ser_2.file_dt) FROM opa_stg_uk.fl_acr_service ser_2 WHERE ser_1.sk_service_id = ser_2.sk_service_id AND ser_1.service_version = ser_2.service_version)\n)\n,fl_acr_service_element AS (\n\tSELECT\n\t\tser_e_1.sk_service_id\n\t\t,ser_e_1.service_version\n\t\t,ser_e_1.atcom_sub_ser_id\n\tFROM opa_stg_uk.fl_acr_service_element ser_e_1\n\tWHERE ser_e_1.file_dt = (SELECT MAX(ser_e_2.file_dt) FROM opa_stg_uk.fl_acr_service_element ser_e_2 WHERE ser_e_1.sk_service_element_id = ser_e_2.sk_service_element_id)\n)\n,ar_transroute AS (\n\tSELECT\n\t\ttr.trans_route_id\n\t\t,tr.route_cd\n\tFROM opa_stg_uk.ar_transroute tr\n\tWHERE tr.file_dt = (SELECT MAX(tr_2.file_dt) FROM opa_stg_uk.ar_transroute tr_2 WHERE tr.trans_route_id = tr_2.trans_route_id)\n)\n,ar_transinvroute AS (\n\tSELECT\n\t\ttir.trans_inv_route_id\n\t\t,tir.trans_route_id\n\tFROM opa_stg_uk.ar_transinvroute tir\n\tWHERE tir.file_dt = (SELECT MAX(tir_2.file_dt) FROM opa_stg_uk.ar_transinvroute tir_2 WHERE tir.trans_inv_route_id = tir_2.trans_inv_route_id)\n)\n,ar_transinvroutesector AS (\n\tSELECT\n\t\ttirs.trans_inv_route_id\n\t\t,tirs.trans_inv_sec_id\n\t\t,tirs.trans_inv_route_sec_id\n\tFROM opa_stg_uk.ar_transinvroutesector tirs\n\tWHERE tirs.file_dt = (SELECT MAX(tirs_2.file_dt) FROM opa_stg_uk.ar_transinvroutesector tirs_2 WHERE tirs.trans_inv_route_sec_id = tirs_2.trans_inv_route_sec_id)\n),\nar_transinvsector AS (\n\tSELECT\n\t\ttis.trans_inv_sec_id\n\t\t,tis.dep_dt_tm\n\tFROM opa_stg_uk.ar_transinvsector tis\n\tWHERE tis.file_dt = (SELECT MAX(tis_2.file_dt) FROM opa_stg_uk.ar_transinvsector tis_2 WHERE tis.trans_inv_sec_id = tis_2.trans_inv_sec_id)\n)\n,ar_point AS (\n\tSELECT\n\t\tp.pt_id\n\t\t,p.pt_cd\n\tFROM opa_stg_uk.ar_point p\n\tWHERE p.file_dt = (SELECT MAX(p_2.file_dt) FROM opa_stg_uk.ar_point p_2 WHERE p.pt_id = p_2.pt_id)\n)\n,dates AS (\n\tSELECT\n\t\tdd.bk_date\n\t\t,dd.group_season_code\n\tFROM opa_stg_all.date_dim dd\n)\n,booking_service AS (\n\tSELECT\n\t\tbk_ser.sk_booking_id\n\t\t,bk_ser.booking_version\n\t\t,bk_ser.sk_service_id\n\t\t,bk_ser.service_version\n\t\t,bk_ser.sk_booking_service_id\n\t\t,ser.service_type\n\t\t,ser.source_stock_type_code\n\t\t,ser.sell_type\n\t\t,ser.service_status\n\t\t,ser.flight_type_code\n\t\t,ser.service_start_date1\n\t\t,ser.service_end_date1\n\t\t,tis.dep_dt_tm\n\t\t,ser.departure_flight_number\n\t\t,ser.direction\n\t\t,tr.route_cd\n\t\t,dpt.pt_cd\n\t\t,CASE WHEN\n\t\t\t-- All flight cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tCASE WHEN\n\t\t\t\tser.service_start_date1 =\n\t\t\t\t\tMIN(CASE WHEN\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\n\t\t\t\t\t\tTHEN ser.service_start_date1\n\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\tEND\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\tTHEN apt.pt_cd\n\t\t\t\tELSE NULL\n\t\t\tEND\n\t\tELSE\n\t\t\tCASE WHEN\n\t\t\t\tser.service_start_date1 =\n\t\t\t\t\tMIN(CASE WHEN\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\t\tTHEN ser.service_start_date1\n\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\tEND\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\tAND ser.service_status = 'CON'\n\t\t\t\tTHEN apt.pt_cd\n\t\t\t\tELSE NULL\n\t\t\tEND\n\t\tEND AS min_flight_gateway\n\n\t\t,CASE WHEN\n\t\t\t-- All flight cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tCASE WHEN\n\t\t\t\tser.service_start_date1 =\n\t\t\t\t\tMIN(CASE WHEN\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\n\t\t\t\t\t\tTHEN ser.service_start_date1\n\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\tEND\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\tTHEN\n\t\t\t\t\tCASE WHEN tr.route_cd IS NULL\n\t\t\t\t\t\tTHEN\n\t\t\t\t\t\t\tser.departure_flight_number|| '|' || dpt.pt_cd || '|' || apt.pt_cd|| '|' || CAST(SUBSTR(ser.service_start_date1,1,4)||SUBSTR(ser.service_start_date1,6,2)||SUBSTR(ser.service_start_date1,9,2) AS VARCHAR)\n\t\t\t\t\t\tELSE\n\t\t\t\t\t\t\ttr.route_cd || '|' || SUBSTRING(tis.dep_dt_tm, 1, 4) || SUBSTRING(tis.dep_dt_tm, 6, 2) || SUBSTRING(tis.dep_dt_tm, 9, 2)\n\t\t\t\t\t\tEND\n\t\t\t\tELSE NULL\n\t\t\tEND\n\t\tELSE\n\t\t\tCASE WHEN\n\t\t\t\tser.service_start_date1 =\n\t\t\t\t\tMIN(CASE WHEN\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\t\tTHEN ser.service_start_date1\n\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\tEND\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\tAND ser.service_status = 'CON'\n\t\t\t\tTHEN\n\t\t\t\t\tCASE WHEN tr.route_cd IS NULL\n\t\t\t\t\t\tTHEN\n\t\t\t\t\t\t\tser.departure_flight_number|| '|' || dpt.pt_cd || '|' || apt.pt_cd|| '|' || CAST(SUBSTR(ser.service_start_date1,1,4)||SUBSTR(ser.service_start_date1,6,2)||SUBSTR(ser.service_start_date1,9,2) AS VARCHAR)\n\t\t\t\t\t\tELSE\n\t\t\t\t\t\t\ttr.route_cd || '|' || SUBSTRING(tis.dep_dt_tm, 1, 4) || SUBSTRING(tis.dep_dt_tm, 6, 2) || SUBSTRING(tis.dep_dt_tm, 9, 2)\n\t\t\t\t\t\tEND\n\t\t\t\tELSE NULL\n\t\t\tEND\n\t\tEND\tAS min_flight_id\n\n\t\t,CASE WHEN\n\t\t\t-- All flight cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tCASE WHEN\n\t\t\t\tser.service_start_date1 =\n\t\t\t\t\tMAX(CASE WHEN\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\n\t\t\t\t\t\tTHEN ser.service_start_date1\n\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\tEND\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\tTHEN\n\t\t\t\t\tCASE WHEN tr.route_cd IS NULL\n\t\t\t\t\t\tTHEN\n\t\t\t\t\t\t\tser.departure_flight_number|| '|' || dpt.pt_cd || '|' || apt.pt_cd|| '|' || CAST(SUBSTR(ser.service_start_date1,1,4)||SUBSTR(ser.service_start_date1,6,2)||SUBSTR(ser.service_start_date1,9,2) AS VARCHAR)\n\t\t\t\t\t\tELSE\n\t\t\t\t\t\t\ttr.route_cd || '|' || SUBSTRING(tis.dep_dt_tm, 1, 4) || SUBSTRING(tis.dep_dt_tm, 6, 2) || SUBSTRING(tis.dep_dt_tm, 9, 2)\n\t\t\t\t\t\tEND\n\t\t\t\tELSE NULL\n\t\t\tEND\n\t\tELSE\n\t\t\tCASE WHEN\n\t\t\t\tser.service_start_date1 =\n\t\t\t\t\tMAX(CASE WHEN\n\t\t\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\t\tTHEN ser.service_start_date1\n\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\tEND\n\t\t\t\t\t) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\tAND ser.service_status = 'CON'\n\t\t\t\tTHEN\n\t\t\t\t\tCASE WHEN tr.route_cd IS NULL\n\t\t\t\t\t\tTHEN\n\t\t\t\t\t\t\tser.departure_flight_number|| '|' || dpt.pt_cd || '|' || apt.pt_cd|| '|' || CAST(SUBSTR(ser.service_start_date1,1,4)||SUBSTR(ser.service_start_date1,6,2)||SUBSTR(ser.service_start_date1,9,2) AS VARCHAR)\n\t\t\t\t\t\tELSE\n\t\t\t\t\t\t\ttr.route_cd || '|' || SUBSTRING(tis.dep_dt_tm, 1, 4) || SUBSTRING(tis.dep_dt_tm, 6, 2) || SUBSTRING(tis.dep_dt_tm, 9, 2)\n\t\t\t\t\t\tEND\n\t\t\t\tELSE NULL\n\t\t\tEND\n\t\tEND AS max_flight_id\n\n\n\t\t-- MULTICENTRE\n\t\t,CASE WHEN\n\t\t\t-- All multicentre services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM')\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CON')\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND\tAS min_multi_center_date\n\n\t\t,CASE WHEN\n\t\t\t-- All multicentre services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM')\n\t\t\t\tTHEN ser.service_end_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'MC' AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CON')\n\t\t\t\tTHEN ser.service_end_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND AS max_multi_center_date\n\n\n\t\t-- ACCOM\n\t\t,CASE WHEN\n\t\t\t-- All accom services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU'))\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM')\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CON')\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND AS min_accom_date\n\t\t,CASE WHEN\n\t\t\t-- All accom services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU'))\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM')\n\t\t\t\tTHEN ser.service_end_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'ACCM' AND ser.service_status = 'CON')\n\t\t\t\tTHEN ser.service_end_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND AS max_accom_date\n\n\n\t\t-- CRUISE\n\t\t,CASE WHEN\n\t\t\t-- All accom services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'CRU')\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' AND ser.service_status = 'CON')\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND AS min_cruise_date\n\t\t,CASE WHEN\n\t\t\t-- All accom services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'CRU')\n\t\t\t\tTHEN ser.service_end_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'CRU' AND ser.service_status = 'CON')\n\t\t\t\tTHEN ser.service_end_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND max_cruise_date\n\n\n\t\t-- FLIGHT\n\t\t,CASE WHEN\n\t\t\t-- All flight services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\n\t\t\t\t--THEN tis.dep_dt_tm END)\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMIN(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t--THEN tis.dep_dt_tm END)\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND AS min_flight_date\n\t\t,CASE WHEN\n\t\t\t-- All flight services cancelled\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t=\n\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tTHEN\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT')\n\t\t\t\t--THEN tis.dep_dt_tm END)\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tELSE\n\t\t\tMAX(CASE WHEN\n\t\t\t\t\t(ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t\tOR (ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.service_status = 'CON')\n\t\t\t\t--THEN tis.dep_dt_tm END)\n\t\t\t\tTHEN ser.service_start_date1 END)\n\t\t\tOVER (PARTITION BY bk_ser.sk_booking_id)\n\t\tEND\tAS max_flight_date\n\n\t\t,sts.cd AS accom\n\t\t,su.bb_cd_id AS board_cd\n\t\t,uc_3.name AS board_name\n\t\t,str.stc_rm_id AS room\n\n\t\t-- Booking type derivation part 1\n\t\t,CASE WHEN\n\t\t\t\t-- No outbound flight services on the booking are third party\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) = 0\n\t\tTHEN 0\n\t\tELSE\n\t\t\tCASE WHEN\n\t\t\t\t-- All outbound flight services are 3PF\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t=\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\n\t\t\tOR\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' AND ser.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) > 1\n\t\t\tTHEN 1\n\t\t\tELSE 0\n\t\t\tEND\n\t\tEND AS tpf_out_count\n\t\t,CASE WHEN\n\t\t\t\t-- No outbound flight services on the booking are third party\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) = 0\n\t\tTHEN 0\n\t\tELSE\n\t\t\tCASE WHEN\n\t\t\t\t-- All outbound flight services are 3PF\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t=\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\n\t\t\tOR\n\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' AND ser.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) > 1\n\t\t\tTHEN 1\n\t\t\tELSE 0\n\t\t\tEND\n\t\tEND AS tpf_in_count\n\t\t,CASE WHEN\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\t-- No outbound flight services on the booking are third party\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) = 0\n\t\t\t\tTHEN 0\n\t\t\t\tELSE\n\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t-- All outbound flight services are 3PF\n\t\t\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\t\t=\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\n\t\t\t\t\tOR\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'OUT' AND ser.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) > 1\n\t\t\t\t\tTHEN 1\n\t\t\t\t\tELSE 0\n\t\t\t\t\tEND\n\t\t\t\tEND\n\t\t\t+\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\t-- No outbound flight services on the booking are third party\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) = 0\n\t\t\t\tTHEN 0\n\t\t\t\tELSE\n\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t-- All outbound flight services are 3PF\n\t\t\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\t\t\t+ SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t\t\t=\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\n\t\t\t\t\tOR\n\t\t\t\t\t\tSUM(CASE WHEN ser.flight_type_code = 'T' AND ser.direction = 'IN' AND ser.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id) > 1\n\t\t\t\t\tTHEN 1\n\t\t\t\t\tELSE 0\n\t\t\t\t\tEND\n\t\t\t\tEND\n\t\t> 0\n\t\t\tTHEN 'Y'\n\t\t\tELSE 'N'\n\t\tEND AS tpf_indicator\n\t\t,CASE WHEN\n\t\t\t\t-- All accom cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') THEN 1 ELSE 0 END\n\t\t\tELSE CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code NOT IN ('MC', 'CRU') AND ser.service_status = 'CON' THEN 1 ELSE 0 END\n\t\tEND AS accom_count\n\t\t,CASE WHEN\n\t\t\t\t-- All cruise cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' THEN 1 ELSE 0 END\n\t\t\tELSE CASE WHEN ser.service_type = 'ACC' AND ser.source_stock_type_code = 'CRU' AND ser.service_status = 'CON' THEN 1 ELSE 0 END\n\t\tEND AS cruise_count\n\t\t,CASE WHEN\n\t\t\t\t-- All flight out cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END\n\t\t\tELSE CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' AND ser.service_status = 'CON' THEN 1 ELSE 0 END\n\t\tEND AS flight_out_count\n\t\t,CASE WHEN\n\t\t\t\t-- All flight in cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END\n\t\t\tELSE CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' AND ser.service_status = 'CON' THEN 1 ELSE 0 END\n\t\tEND AS flight_ret_count\n\t\t,CASE WHEN\n\t\t\t\t-- All ahoc services cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'AHOC' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'AHOC' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'AHOC' THEN 1 ELSE 0 END\n\t\t\tELSE CASE WHEN ser.service_type = 'AHOC' AND ser.service_status = 'CON' THEN 1 ELSE 0 END\n\t\tEND AS thirdparty_count\n\n\t\t,CASE WHEN\n\t\t\t\t-- All flight out first date cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' THEN ser.service_start_date1 ELSE NULL END\n\t\t\tELSE CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'OUT' AND ser.service_status = 'CON' THEN ser.service_start_date1 ELSE NULL END\n\t\tEND AS flight_out_first_date\n\t\t,CASE WHEN\n\t\t\t\t-- All flight in first date cancelled\n\t\t\t\tSUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' AND ser.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bk_ser.sk_booking_id)\n\t\t\tTHEN CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' THEN ser.service_start_date1 ELSE NULL END\n\t\t\tELSE CASE WHEN ser.service_type = 'TRS' AND ser.sell_type = 'FLT' AND ser.direction = 'IN' AND ser.service_status = 'CON' THEN ser.service_start_date1 ELSE NULL END\n\t\tEND AS flight_ret_first_date\n\n\t-- Service and subservice\n\tFROM fl_acr_booking_service bk_ser\n\tLEFT OUTER JOIN fl_acr_service ser ON bk_ser.sk_service_id = ser.sk_service_id AND bk_ser.service_version = ser.service_version\n\tLEFT OUTER JOIN fl_acr_service_element ser_e ON ser.sk_service_id = ser_e.sk_service_id AND ser.service_version = ser_e.service_version\n\n\t-- Accom\n\tLEFT OUTER JOIN ar_sellstatic sls ON ser.atcom_ser_id = sls.sell_stc_id\n\tLEFT OUTER JOIN ar_staticstock sts ON sls.stc_stk_id = sts.stc_stk_id\n\n\t-- Room\n\tLEFT OUTER JOIN ar_sellunit su ON ser_e.atcom_sub_ser_id = su.sell_unit_id\n\tLEFT OUTER JOIN ar_staticroom str ON sts.stc_stk_id = str.stc_stk_id AND su.rm_id = str.rm_id\n\n\t-- Board\n\tLEFT OUTER JOIN ar_usercodes uc_3 ON su.bb_cd_id = uc_3.user_cd_id\n\n\t-- Flight\n\tLEFT OUTER JOIN ar_transinvroute tir ON ser.atcom_ser_id = tir.trans_inv_route_id\n\tLEFT OUTER JOIN ar_transroute tr ON tir.trans_route_id = tr.trans_route_id\n\tLEFT OUTER JOIN ar_transinvroutesector tirs ON tir.trans_inv_route_id = tirs.trans_inv_route_id\n      LEFT OUTER JOIN ar_transinvsector tis ON tirs.trans_inv_sec_id = tis.trans_inv_sec_id\n\tLEFT OUTER JOIN ar_point dpt ON ser.atcom_dep_point_id = dpt.pt_id\n\tLEFT OUTER JOIN ar_point apt ON ser.atcom_arr_point_id = apt.pt_id\n\n\tORDER BY\n\t\tbk_ser.sk_booking_id\n\t\t,bk_ser.booking_version\n\t\t,ser.source_stock_type_code\n\n)\n,ar_agent AS (\n\tSELECT DISTINCT\n\t\tag_1.agt_id\n\t\t,ag_1.def_mkt_id\n\t\t,ag_1.agt_tp_id\n\tFROM opa_stg_uk.ar_agent ag_1\n\tWHERE ag_1.file_dt = (SELECT MAX(ag_2.file_dt) FROM opa_stg_uk.ar_agent ag_2 WHERE ag_1.agt_id = ag_2.agt_id)\n)\n,ar_market AS (\n\tSELECT DISTINCT\n\t\tmk_1.mkt_id\n\t\t,mk_1.off_id\n\tFROM opa_stg_uk.ar_market mk_1\n\tWHERE mk_1.file_dt = (SELECT MAX(mk_2.file_dt) FROM opa_stg_uk.ar_market mk_2 WHERE mk_1.mkt_id = mk_2.mkt_id)\n)\n,ar_officename AS (\n\tSELECT DISTINCT\n\t\tofn_1.off_name_id\n\t\t,ofn_1.cd\n\t\t,ofn_1.name\n\t\t-- ,sm.source_market_code\n\tFROM opa_stg_uk.ar_officename ofn_1\n\t-- LEFT OUTER JOIN opa_stg_all.source_market sm ON 'UKATCOM|' || ofn_1.cd = bk_source_market\n\tWHERE ofn_1.file_dt = (SELECT MAX(ofn_2.file_dt) FROM opa_stg_uk.ar_officename ofn_2 WHERE ofn_1.off_name_id = ofn_2.off_name_id)\n)\n,ar_currency AS (\n\tSELECT DISTINCT\n\t\tcur_1.cur_id\n\t\t,cur_1.cd\n\t\t,cur_1.name\n\tFROM opa_stg_uk.ar_currency cur_1\n\tWHERE cur_1.file_dt = (SELECT MAX(cur_2.file_dt) FROM opa_stg_uk.ar_currency cur_2 WHERE cur_1.cur_id = cur_2.cur_id)\n)\n\t,booking_fact_margin AS (\n\tSELECT\n\t\tbff_1.bk_booking\n\t\t,bff_1.ffd_flag\n\t\t,bff_1.sm_currency\n\t\t,bff_1.sm_revenue\n\t\t,bff_1.sm_cnx_and_amend_revenue\n\t\t,bff_1.sm_accommodation_costs\n\t\t,bff_1.sm_early_booking_discounts\n\t\t,bff_1.sm_late_booking_discounts\n\t\t,bff_1.sm_flying_costs\n\t\t,bff_1.sm_other_costs\n\t\t,bff_1.sm_distribution_costs\n\t\t,bff_1.sm_non_margin_items\n\t\t,bff_1.sm_margin\n\t\t,bff_1.smg_currency\n\t\t,bff_1.smg_revenue\n\t\t,bff_1.smg_cnx_and_amend_revenue\n\t\t,bff_1.smg_accommodation_costs\n\t\t,bff_1.smg_early_booking_discounts\n\t\t,bff_1.smg_late_booking_discounts\n\t\t,bff_1.smg_flying_costs\n\t\t,bff_1.smg_other_costs\n\t\t,bff_1.smg_distribution_costs\n\t\t,bff_1.smg_non_margin_items\n\t\t,bff_1.smg_margin\n\t\t,bff_1.rep_currency\n\t\t,bff_1.rep_revenue\n\t\t,bff_1.rep_cnx_and_amend_revenue\n\t\t,bff_1.rep_accommodation_costs\n\t\t,bff_1.rep_early_booking_discounts\n\t\t,bff_1.rep_late_booking_discounts\n\t\t,bff_1.rep_flying_costs\n\t\t,bff_1.rep_other_costs\n\t\t,bff_1.rep_distribution_costs\n\t\t,bff_1.rep_non_margin_items\n\t\t,bff_1.rep_margin\n\tFROM opa_fl_uk.v_booking_fact_margin_uk bff_1\n)\n,booking_fact_1 AS (\n\tSELECT DISTINCT\n\t\tCASE WHEN bk.atcom_res_id IS NULL THEN NULL ELSE 'UKATCOM|' || bk.atcom_res_id END AS bk_booking\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t=\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN 'U'\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN 'U'\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\tEND AS bk_primary_accom\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t=\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN 'U'\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN 'U'\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.room ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\tEND AS bk_primary_room\n\t\t,COALESCE(\n\t\t\tCASE WHEN\n\t\t\t\tMIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) = MIN(bs.max_flight_id) OVER (PARTITION BY bk.atcom_res_id)\n\t\t\t\tAND COUNT(DISTINCT bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) > 1\n\t\t\t\t\tTHEN 'MULTI'\n\t\t\tWHEN\n\t\t\t\tMIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) = MIN(bs.max_flight_id) OVER (PARTITION BY bk.atcom_res_id)\n\t\t\t\tAND COUNT(DISTINCT bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) = 1\n\t\t\t\t\tTHEN 'UKATCOM|' || MIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id)\n\t\t\tWHEN SUM(bs.flight_out_count) OVER (PARTITION BY bk.atcom_res_id) > 1\n\t\t\t\tTHEN 'MULTI'\n\t\t\t\tELSE 'UKATCOM|' || MIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id)\n\t\t\tEND\n\t\t, 'U') AS bk_first_flight\n\t\t,COALESCE(\n\t\t\tCASE WHEN\n\t\t\t\tMIN(bs.min_flight_id) OVER (PARTITION BY bk.atcom_res_id) = MIN(bs.max_flight_id) OVER (PARTITION BY bk.atcom_res_id)\n\t\t\t\t\tTHEN NULL\n\t\t\tWHEN SUM(bs.flight_ret_count) OVER (PARTITION BY bk.atcom_res_id) > 1\n\t\t\t\tTHEN 'MULTI'\n\t\t\t\tELSE 'UKATCOM|' || MIN(bs.max_flight_id) OVER (PARTITION BY bk.atcom_res_id)\n\t\t\tEND\n\t\t, 'U') AS bk_last_flight\n\t\t,CASE WHEN ofn.cd IS NULL\n\t\t\tTHEN 'UKATCOM|U'\n\t\t\tELSE 'UKATCOM|' || ofn.cd\n\t\tEND AS bk_source_market\n\t\t,'UKATCOM' AS bk_originating_system\n\t\t,CASE WHEN\n\t\t\t\t-- Third party flight\n\t\t\t\tSUM(CASE WHEN bs.tpf_indicator = 'Y' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\t\tTHEN 'UKATCOM|3PF'\n\n\t\t\tWHEN\n\t\t\t\t-- Accommodation and Flight Package\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|PKG' -- Granular code = 'PKGAF'\n\n\t\t\tWHEN\n\t\t\t\t-- Cruise and Flight Package\n\t\t\t\tSUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) > 0\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGCF'\n\n\t\t\tWHEN\n\t\t\t\t-- Cruise and Accommodation and Flight Package\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) > 0\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGCAF'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Accommodation and Flight Package\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|PKG' -- Granular code = 'PKGMAF'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Cruise and Flight Package\n\t\t\t\tSUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGMCF'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Accommodation and One Cruise and Flight Package\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGMACF'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Cruise and One Accommodation and Flight Package\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGMCAF'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Accommodation and Multi Cruise and Flight Package\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'PKGMAMCF'\n\n\t\t\tWHEN\n\t\t\t\t-- Single Accommodation Only\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|ACC' -- Granular code = 'ACCA'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Accommodation Only\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\tAND SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|ACC' -- Granular code = 'ACCMA'\n\n\t\t\tWHEN\n\t\t\t\t-- Accommodation and Flight Other\n\t\t\t\tSUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 1\n\t\t\t\t\tTHEN 'UKATCOM|PKG' -- Granular code = 'ACCOTH'\n\n\t\t\tWHEN\n\t\t\t\t-- Flight Only Return Outbound First\n\t\t\t\tSUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND MIN(bs.flight_out_first_date) OVER (PARTITION BY bs.sk_booking_id) < MIN(bs.flight_ret_first_date) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTROF'\n\n\t\t\tWHEN\n\t\t\t\t-- Flight Only Return Inbound First\n\t\t\t\tSUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND MIN(bs.flight_ret_first_date) OVER (PARTITION BY bs.sk_booking_id) < MIN(bs.flight_out_first_date) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTRIF'\n\n\t\t\tWHEN\n\t\t\t\t-- Flight only same day return\n\t\t\t\tSUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND MIN(bs.flight_ret_first_date) OVER (PARTITION BY bs.sk_booking_id) = MIN(bs.flight_out_first_date) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTSDR'\n\n\t\t\tWHEN\n\t\t\t\t-- Flight Only One Way Outbound\n\t\t\t\tSUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\tAND (SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTOBO'\n\n\t\t\tWHEN\n\t\t\t\t-- Flight Only One Way Inbound\n\t\t\t\tSUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\tAND (SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\t\tTHEN 'UKATCOM|FLT' -- Granular code = 'FLTIBO'\n\n\t\t\tWHEN\n\t\t\t\t-- Single Cruise Only\n\t\t\t\tSUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) = 1\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\tAND SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) = 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'CRUSGL'\n\n\t\t\tWHEN\n\t\t\t\t-- Multi Cruise Only\n\t\t\t\tSUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\t\tTHEN 'UKATCOM|CRU' -- Granular code = 'CRUMLT'\n\n\t\t\tWHEN\n\t\t\t\t-- Third party\n\t\t\t\tSUM(bs.thirdparty_count) OVER (PARTITION BY bs.sk_booking_id) > 0\n\t\t\t\tAND (SUM(bs.flight_out_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.flight_ret_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\tAND (SUM(bs.accom_count) OVER (PARTITION BY bs.sk_booking_id) + SUM(bs.cruise_count) OVER (PARTITION BY bs.sk_booking_id)) = 0\n\t\t\t\t\tTHEN 'UKATCOM|TPB' -- Granular code = 'TPB'\n\n\t\t\tELSE 'UKATCOM|OTH'\n\t\tEND AS bk_booking_type\n\t\t,CASE WHEN bk.booking_status IS NULL\n\t\t\tTHEN 'U'\n\t\t\tELSE 'UKATCOM|' || bk.booking_status\n\t\tEND AS bk_booking_status\n\t\t,bk.atcom_res_id AS source_booking_id\n\t\t,bk.atcom_res_version AS source_booking_version\n\t\t,COALESCE(CAST(bk.source_created_on AS TIMESTAMP), CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS booking_created_datetime\n\t\t,COALESCE(bk.confirmed_on, CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS booking_confirmed_datetime\n\t\t,COALESCE(bk.cancelled_on, CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS booking_cancelled_datetime\n\t\t,gs.group_season_code AS group_season\n\t\t,CASE WHEN bk.sk_season_id IS NULL OR bk.sk_season_id = -1 OR bk.sk_season_id = -2\n\t\t\tTHEN NULL\n\t\t\tELSE\n\t\t\t\tCASE WHEN SUBSTRING(bk.sk_season_id, 5, 2) = 01\n\t\t\t\t\tTHEN 'S' || SUBSTRING(bk.sk_season_id, 3, 2)\n\t\t\t\t\tELSE 'W' || SUBSTRING(bk.sk_season_id, 3, 2)\n\t\t\t\tEND\n\t\tEND AS sm_season\n\t\t,CASE WHEN uc.cd IS NULL\n\t\t\tTHEN NULL\n\t\t\tELSE 'UKATCOM|' || uc.cd\n\t\tEND AS channel_code\n\t\t,CASE WHEN uc.name IS NULL\n\t\t\tTHEN NULL\n\t\t\tELSE 'UKATCOM|' || uc.name\n\t\tEND AS channel_desc\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t=\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN NULL\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN NULL\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\tEND AS booked_board_code\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t=\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t+ SUM(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN NULL\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.board_name ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' THEN bs.board_name ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tCASE WHEN\n\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t= 0\n\t\t\t\t\tTHEN NULL\n\t\t\t\t\tELSE\n\t\t\t\t\t\tCASE WHEN\n\t\t\t\t\t\t\tCOUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t+ COUNT(DISTINCT CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_cd ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t> 1\n\t\t\t\t\t\tTHEN 'MULTI'\n\n\t\t\t\t\t\tELSE 'UKATCOM|' || COALESCE(\n\t\t\t\t\t\t\t\tMIN(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.board_name ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t\t,MIN(CASE WHEN bs.service_type = 'AHOC' AND bs.sell_type = 'ACCM' AND bs.service_status = 'CON' THEN bs.board_name ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\t\tEND AS booked_board_name\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services are cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tCASE WHEN SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\t\tTHEN 'Y'\n\t\t\t\t\tELSE 'N'\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tCASE WHEN SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\t\tTHEN 'Y'\n\t\t\t\t\tELSE 'N'\n\t\t\t\tEND\n\t\tEND AS multi_room_booking\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services are cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tELSE\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\tEND AS number_of_booked_rooms\n\t\t,CASE WHEN\n\t\t\t\t-- All accom services are cancelled\n\t\t\t\tSUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\t\t= SUM(CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CNX' THEN 1 ELSE 0 END) OVER (PARTITION BY bs.sk_booking_id)\n\t\t\tTHEN\n\t\t\t\tCASE WHEN COUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\t\tTHEN 'Y'\n\t\t\t\t\tELSE 'N'\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tCASE WHEN COUNT(DISTINCT CASE WHEN bs.service_type = 'ACC' AND bs.source_stock_type_code NOT IN ('MC') AND bs.service_status = 'CON' THEN bs.accom ELSE NULL END) OVER (PARTITION BY bs.sk_booking_id) > 1\n\t\t\t\t\tTHEN 'Y'\n\t\t\t\t\tELSE 'N'\n\t\t\t\tEND\n\t\tEND AS multi_centre_booking\n\t\t,COALESCE(bk.season_date,CAST('2999-12-31 23:59:59.0' AS DATE)) AS departure_date\n\t\t,COALESCE(\n\t\t\tbs.max_multi_center_date,\n\t\t\tbs.max_accom_date,\n\t\t\tbs.max_cruise_date,\n\t\t\tbs.max_flight_date,\n\t\t\tCAST('2999-12-31 23:59:59.0' AS DATE)\n\t\t) AS return_date\n\t\t,CASE WHEN\n\t\t\tCOALESCE(bk.season_date, CAST('2999-12-31 23:59:59.0' AS DATE)) = CAST('2999-12-31 23:59:59.0' AS DATE)\n\t\tOR\n\t\t\tCOALESCE(\n\t\t\t\tbs.max_multi_center_date,\n\t\t\t\tbs.max_accom_date,\n\t\t\t\tbs.max_cruise_date,\n\t\t\t\tbs.max_flight_date,\n\t\t\t\tCAST('2999-12-31 23:59:59.0' AS DATE)\n\t\t\t) = CAST('2999-12-31 23:59:59.0' AS DATE)\n\t\tTHEN 0\n\t\tELSE\n\t\t\tDATEDIFF('DAY',\n\t\t\t\tbk.season_date\n\t\t\t,\n\t\t\t\tCOALESCE(\n\t\t\t\t\tbs.max_multi_center_date,\n\t\t\t\t\tbs.max_accom_date,\n\t\t\t\t\tbs.max_cruise_date,\n\t\t\t\t\tbs.max_flight_date)\n\t\t\t)\n\t\tEND\tAS DURATION\n\t\t,COALESCE(bk.number_of_adults, 0) AS std_number_of_booking_adult_pax\n\t\t,COALESCE(bk.number_of_children, 0) AS std_number_of_booking_child_pax\n\t\t,COALESCE(bk.number_of_infants, 0) AS std_number_of_booking_infant_pax\n\t\t,COALESCE(bk.number_of_passengers, 0) AS std_number_of_booking_pax\n\t\t,COALESCE(bk.number_of_adults, 0) AS sm_number_of_booking_adult_pax\n\t\t,0 AS sm_number_of_booking_teenager_pax\n\t\t,COALESCE(bk.number_of_children, 0) AS sm_number_of_booking_child_pax\n\t\t,COALESCE(bk.number_of_infants, 0) AS sm_number_of_booking_infant_pax\n\t\t,COALESCE(bk.number_of_passengers, 0) AS sm_number_of_booking_pax\n\t\t,CASE WHEN COUNT(DISTINCT bs.min_flight_gateway) OVER (PARTITION BY bk.atcom_res_id) > 1\n\t\t\tTHEN 'MULTI'\n\t\t\tELSE MIN(bs.min_flight_gateway) OVER (PARTITION BY bk.atcom_res_id)\n\t\tEND AS primary_gateway\n\t\t,cur.name AS currency\n\t\t,COALESCE(bk.dwh_created_on, CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS sm_created_datetime\n\t\t,COALESCE(bk.dwh_modified_on, CAST('2999-12-31 23:59:59.0' AS TIMESTAMP)) AS sm_updated_datetime\n\t\t,CAST(CONVERT_TIMEZONE('Europe/London',CURRENT_TIMESTAMP()) AS TIMESTAMP_NTZ) AS dm_created_datetime\n\n\tFROM fl_acr_booking bk\n\tLEFT OUTER JOIN booking_service bs ON bk.sk_booking_id = bs.sk_booking_id AND bk.booking_version = bs.booking_version\n\n\t-- Group Season\n\tLEFT OUTER JOIN dates gs ON CAST(COALESCE(SUBSTRING(bk.season_date, 1, 4) || SUBSTRING(bk.season_date, 6, 2) || SUBSTRING(bk.season_date, 9, 2), 20991231) AS INTEGER) = gs.bk_date\n\n\t-- Market source\n\tLEFT OUTER JOIN ar_agent ag ON bk.atcom_agent_id = ag.agt_id\n\n      -- V1.06 Version of source market joins\n      LEFT OUTER JOIN ar_market m   ON bk.atcom_market_id = m.mkt_id\n      LEFT OUTER JOIN ar_officename ofn ON m.off_id = ofn.off_name_id\n\n\t-- Channel\n\tLEFT OUTER JOIN ar_usercodes uc ON ag.agt_tp_id = uc.user_cd_id\n\n\t-- Currency\n\tLEFT OUTER JOIN ar_currency cur ON bk.atcom_sell_currency_id = cur.cur_id\n\n\tWHERE bk_booking IS NOT NULL\n)\n\nSELECT\n\tbf.bk_booking,\n\tbf.bk_primary_accom,\n\tbf.bk_primary_room,\n\tbf.bk_first_flight,\n\tbf.bk_last_flight,\n\tbf.bk_source_market,\n\tbf.bk_originating_system,\n\tbf.bk_booking_type,\n\tbf.bk_booking_status,\n\tbf.source_booking_id,\n\tbf.source_booking_version,\n\tbf.booking_created_datetime,\n\tbf.booking_confirmed_datetime,\n\tbf.booking_cancelled_datetime,\n\tbf.group_season,\n\tbf.sm_season,\n\tbf.channel_code,\n\tbf.channel_desc,\n\tbf.booked_board_code,\n\tbf.booked_board_name,\n\tbf.multi_room_booking,\n\tbf.number_of_booked_rooms,\n\tbf.multi_centre_booking,\n\tbf.departure_date,\n\tbf.return_date,\n\tbf.duration,\n\tbf.std_number_of_booking_adult_pax,\n\tbf.std_number_of_booking_child_pax,\n\tbf.std_number_of_booking_infant_pax,\n\tbf.std_number_of_booking_pax,\n\tbf.sm_number_of_booking_adult_pax,\n\tbf.sm_number_of_booking_teenager_pax,\n\tbf.sm_number_of_booking_child_pax,\n\tbf.sm_number_of_booking_infant_pax,\n\tbf.sm_number_of_booking_pax,\n\tbf.primary_gateway,\n\t\tCOALESCE(bfm.sm_currency, fx.bk_sm_ccy, 'U') AS sm_currency,\n\tCOALESCE(bfm.sm_revenue, 0) AS sm_revenue,\n\tCOALESCE(bfm.sm_cnx_and_amend_revenue, 0) AS sm_cnx_and_amend_revenue,\n\tCOALESCE(bfm.sm_accommodation_costs, 0) AS sm_accommodation_costs,\n\tCOALESCE(bfm.sm_early_booking_discounts, 0) AS sm_early_booking_discounts,\n\tCOALESCE(bfm.sm_late_booking_discounts, 0) AS sm_late_booking_discounts,\n\tCOALESCE(bfm.sm_flying_costs, 0) AS sm_flying_costs,\n\tCOALESCE(bfm.sm_other_costs, 0) AS sm_other_costs,\n\tCOALESCE(bfm.sm_distribution_costs, 0) AS sm_distribution_costs,\n\tCOALESCE(bfm.sm_non_margin_items, 0) AS sm_non_margin_items,\n\tCOALESCE(bfm.sm_margin, 0) AS sm_margin,\n\tCOALESCE(bfm.smg_currency, fx.bk_smg_ccy, 'U') AS smg_currency,\n\tCOALESCE(bfm.smg_revenue, 0) AS smg_revenue,\n\tCOALESCE(bfm.smg_cnx_and_amend_revenue, 0) AS smg_cnx_and_amend_revenue,\n\tCOALESCE(bfm.smg_accommodation_costs, 0) AS smg_accommodation_costs,\n\tCOALESCE(bfm.smg_early_booking_discounts, 0) AS smg_early_booking_discounts,\n\tCOALESCE(bfm.smg_late_booking_discounts, 0) AS smg_late_booking_discounts,\n\tCOALESCE(bfm.smg_flying_costs, 0) AS smg_flying_costs,\n\tCOALESCE(bfm.smg_other_costs, 0) AS smg_other_costs,\n\tCOALESCE(bfm.smg_distribution_costs, 0) AS smg_distribution_costs,\n\tCOALESCE(bfm.smg_non_margin_items, 0) AS smg_non_margin_items,\n\tCOALESCE(bfm.smg_margin, 0) AS smg_margin,\n\tCOALESCE(bfm.rep_currency, fx.bk_rep_ccy, 'U') AS rep_currency,\n\tCOALESCE(bfm.rep_revenue, 0) AS rep_revenue,\n\tCOALESCE(bfm.rep_cnx_and_amend_revenue, 0) AS rep_cnx_and_amend_revenue,\n\tCOALESCE(bfm.rep_accommodation_costs, 0) AS rep_accommodation_costs,\n\tCOALESCE(bfm.rep_early_booking_discounts, 0) AS rep_early_booking_discounts,\n\tCOALESCE(bfm.rep_late_booking_discounts, 0) AS rep_late_booking_discounts,\n\tCOALESCE(bfm.rep_flying_costs, 0) AS rep_flying_costs,\n\tCOALESCE(bfm.rep_other_costs, 0) AS rep_other_costs,\n\tCOALESCE(bfm.rep_distribution_costs, 0) AS rep_distribution_costs,\n\tCOALESCE(bfm.rep_non_margin_items, 0) AS rep_non_margin_items,\n\tCOALESCE(bfm.rep_margin, 0) AS rep_margin,\n\tCOALESCE(bfm.ffd_flag, 'N') AS ffd_flag,\n\tbf.sm_created_datetime,\n\tbf.sm_updated_datetime,\n\tbf.dm_created_datetime\nFROM booking_fact_1 bf\nLEFT OUTER JOIN booking_fact_margin bfm ON bf.bk_booking = bfm.bk_booking\nLEFT OUTER JOIN opa_fl_all.source_market sm ON bf.bk_source_market = sm.bk_source_market\nLEFT OUTER JOIN opa_fl_uk.fx_rates_dim_uk fx\n\tON bf.sm_season = fx.bk_season\n\tAND sm.source_market_code = fx.source_market_code", "wrapped_sql": "None", "build_path": "target\\compiled\\dbt_test\\v_booking_fact_uk.sql"}, "error": null, "skip": false, "status": null, "fail": null, "warn": null, "execution_time": 0.6119999885559082, "thread_id": "Thread-1", "timing": [{"name": "compile", "started_at": "2019-09-30T15:57:28.810189Z", "completed_at": "2019-09-30T15:57:28.863189Z"}, {"name": "execute", "started_at": "2019-09-30T15:57:28.864189Z", "completed_at": "2019-09-30T15:57:28.867189Z"}]}, {"node": {"name": "create_table_booking_fact_uk", "root_path": "C:\\Users\\EXTMB2\\github\\dbt_test", "resource_type": "model", "path": "create_table_booking_fact_uk.sql", "original_file_path": "models\\create_table_booking_fact_uk.sql", "package_name": "dbt_test", "raw_sql": "{{\r\n  config(materialized='table')\r\n}}\r\n\r\nwith view_booking_fact as (\r\n  select * from {{ref('v_booking_fact_uk')}}\r\n)\r\nSELECT * from view_booking_fact", "refs": [["v_booking_fact_uk"]], "sources": [], "depends_on": {"nodes": ["model.dbt_test.v_booking_fact_uk"], "macros": []}, "unique_id": "model.dbt_test.create_table_booking_fact_uk", "empty": false, "fqn": ["dbt_test", "create_table_booking_fact_uk"], "tags": [], "config": {"enabled": true, "materialized": "table", "pre-hook": [], "post-hook": [], "tags": [], "column_types": {}, "vars": {}, "quoting": {}, "persist_docs": {}}, "schema": "DBT_TEST", "database": "OPA_DEV", "alias": "create_table_booking_fact_uk", "columns": {}, "description": "", "compiled": true, "compiled_sql": "\n\nwith view_booking_fact as (\n  select * from OPA_DEV.DBT_TEST.v_booking_fact_uk\n)\nSELECT * from view_booking_fact", "extra_ctes_injected": true, "extra_ctes": [], "injected_sql": "\n\nwith view_booking_fact as (\n  select * from OPA_DEV.DBT_TEST.v_booking_fact_uk\n)\nSELECT * from view_booking_fact", "wrapped_sql": "None", "build_path": "target\\compiled\\dbt_test\\create_table_booking_fact_uk.sql"}, "error": null, "skip": false, "status": null, "fail": null, "warn": null, "execution_time": 0.029000043869018555, "thread_id": "Thread-1", "timing": [{"name": "compile", "started_at": "2019-09-30T15:57:28.879189Z", "completed_at": "2019-09-30T15:57:28.902189Z"}, {"name": "execute", "started_at": "2019-09-30T15:57:28.902189Z", "completed_at": "2019-09-30T15:57:28.906189Z"}]}], "generated_at": "2019-09-30T15:57:29.143189Z", "elapsed_time": 0.7269999980926514}